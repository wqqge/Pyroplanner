<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>🎆 FirePlanner 2D - Pro Advanced (Bereinigt)</title>
<style>
/* --- Behalte das Original-Design (leicht gekürzt für Lesbarkeit) --- */
body { box-sizing: border-box; font-family: Arial, sans-serif; margin: 0; background: #111; color: #eee; }
h1,h2 { text-align:center; margin:10px 0; }
input,button,select,textarea { margin:5px; padding:8px; background:#222; color:#fff; border:1px solid #555; border-radius:5px; font-size:14px; outline:none; }
input:focus,textarea:focus,select:focus { background:#333; border-color:#4caf50; box-shadow:0 0 5px rgba(76,175,80,0.3); }
#container{ display:flex; flex-wrap:wrap; justify-content:center; gap:20px;}
#effectList{ max-width:400px; margin:10px; }
.effect-item{ border:1px solid #555; padding:10px; margin:8px 0; border-radius:5px; background:#222; cursor:move; display:flex; justify-content:space-between; align-items:center;}
.effect-item:hover{ background:#333; transform:translateY(-2px); }
#canvasContainer{ position:relative; margin:10px auto; border:2px solid #555; background:#000; border-radius:8px; }
#fireworkCanvas{ cursor:crosshair; display:block; border-radius:6px; }
#timerDisplay{ font-size:3em; text-align:center; margin:20px 0; font-weight:bold; color:#0ff; }
#currentEffect{ font-size:1.4em; color:#ff0; text-align:center; margin:15px 0; padding:10px; background:#222; border-radius:5px; min-height:60px; }
.controls{ text-align:center; margin:20px 0; padding:15px; background:#222; border-radius:8px; }
#costCalculation{ text-align:center; margin:20px 0; padding:15px; background:#1a4d1a; border-radius:8px; border:2px solid #2e7d32; }
#totalCost{ font-size:1.5em; font-weight:bold; color:#81c784; }
.overview-table{ width:100%; border-collapse:collapse; background:#222; border-radius:5px; overflow:hidden; }
.overview-table th{ background:#333; color:#fff; padding:10px 8px; text-align:left; font-size:12px; border-bottom:2px solid #555; }
.overview-table td{ padding:8px; border-bottom:1px solid #444; font-size:11px; color:#ddd; }
.image-preview{ max-width:200px; max-height:150px; border-radius:5px; border:2px solid #555; margin:10px 0; }
.effect-image{ max-width:50px; max-height:50px; border-radius:3px; margin-right:10px; vertical-align:middle; }
.effect-video{ max-width:50px; max-height:50px; border-radius:3px; margin-right:10px; vertical-align:middle; }
#warningFlash{ position:absolute; top:0; left:0; width:100%; height:100%; background:red; opacity:0; pointer-events:none; border-radius:5px; transition:opacity 0.1s; }
@media print{
  button, select, input, textarea, .effect-delete, .effect-edit { display:none !important; }
  #effectList h3, #effectList .effect-item button { display:none !important; }
  .controls, #container > #effectList { display:none !important; }
}
</style>
</head>
<body>

<h1>🎆 FirePlanner 2D - Pro Advanced (Bereinigt)</h1>

<div id="planScreen">
  <h2>Show-Name</h2>
  <input id="showName" placeholder="Name der Show">

  <h2>Effekt hinzufügen</h2>
  <select id="effectSavedList" onchange="selectSavedEffect()">
    <option value="">Vorherige Effekte</option>
  </select>
  <div style="position:relative; display:inline-block;">
    <select id="effectDatabase" onchange="selectFromDatabase()"><option value="">Effekt-Datenbank</option></select>
    <input type="text" id="effectSearch" placeholder="🔍 Effekt suchen..." style="display:none; position:absolute; top:0; left:0; width:100%; z-index:10;" onkeyup="searchEffects()" onblur="hideSearch()">
  </div>
  <button onclick="showSearch()" id="searchButton" style="display:none;">🔍 Suchen</button><br>

  <div class="database-info">
    📊 <strong>Excel-Import Format:</strong> Name | Barcode | Dauer | Preis | Typ | Lagerbestand
  </div>

  <h3>📸 Bild für Effekt (Optional)</h3>
  <input type="file" id="effectImage" accept="image/*" onchange="previewImage()">
  <div id="imagePreview" style="margin:10px 0;"></div>
  <button onclick="clearImage()">🗑️ Bild entfernen</button>

  <h3>🎬 Video-Vorschau (Optional)</h3>
  <input type="file" id="effectVideo" accept="video/*" onchange="previewVideo()">
  <div id="videoPreview" style="margin:10px 0;"></div>
  <button onclick="clearVideo()">🗑️ Video entfernen</button>

  <input id="name" placeholder="Effektname">
  <select id="effectType">
    <option value="rocket">Rakete</option>
    <option value="fountain">Fontäne</option>
    <option value="battery">Batterie</option>
  </select>
  <input id="plannedDuration" placeholder="Dauer (m:s)">
  <input id="price" placeholder="Preis (€)" type="number" step="0.01">
  <input id="barcode" placeholder="Barcode/EAN">
  <input id="time" placeholder="Showzeit (m:s)">
  <input id="channel" placeholder="Kanal" type="number" min="1">
  <input id="receiver" placeholder="Empfänger">
  <input id="buttonKey" placeholder="Taste">
  <input id="quantity" placeholder="Anzahl Effekte">
  <input id="stockQuantity" placeholder="Lagerbestand" type="number">
  <textarea id="additionalInfo" placeholder="Zusatzinfos"></textarea>
  <button onclick="addEffect()">Effekt speichern</button>
  <button onclick="addToDatabase()">Zur Datenbank hinzufügen</button>
  <input type="file" id="excelImport" accept=".csv,.txt,.tsv" onchange="importExcelDatabase()">
  <button onclick="document.getElementById('excelImport').click()">📊 Excel-Datenbank importieren</button>
  <button onclick="clearDatabase()">🗑️ Datenbank leeren</button>

  <div id="container">
    <div id="canvasContainer">
      <canvas id="fireworkCanvas" width="800" height="500"></canvas>
      <div id="warningFlash"></div>
    </div>
    <div id="effectList"></div>
  </div>

  <div id="costCalculation">
    <h3>💰 Kostenkalkulation</h3>
    <div id="totalCost">Gesamtkosten: 0,00 €</div>
    <div id="effectCount">Anzahl Effekte: 0</div>
  </div>

  <div id="inventoryWarning" style="display:none;">
    <h3>⚠️ Lagerbestand-Warnung</h3>
    <div id="lowStockItems"></div>
  </div>

  <div id="effectOverview">
    <h3>📋 Effekt-Übersicht</h3>
    <div id="overviewTable"></div>
  </div>

  <h2>🎵 Musik & Beat-Sync</h2>
  <input type="file" id="musicFile" accept="audio/*" onchange="loadMusic()">
  <button onclick="analyzeBeat()" id="beatAnalyzeBtn" style="display:none;">🎵 Beat analysieren</button>
  <button onclick="autoSyncEffects()" id="autoSyncBtn" style="display:none;">⚡ Auto-Sync zu Beats</button>
  <div id="beatInfo" style="display:none;">
    <strong>🎵 Beat-Analyse:</strong><br>
    <span id="bpmDisplay">BPM: Nicht analysiert</span><br>
    <span id="beatCount">Beats gefunden: 0</span>
  </div>

  <h2>📡 Zündanlagen-Verwaltung</h2>
  <div style="background:#1a1a2e; padding:20px; border-radius:8px; border:2px solid #16213e; margin:20px 0;">
    <h3 style="color:#4caf50; margin:0 0 15px 0;">🎯 Effekt zu Zündbox zuweisen</h3>

    <div id="currentSelection" style="background:#222; padding:15px; border-radius:5px; margin:10px 0; border-left:4px solid #4caf50;">
      <p style="color:#666; font-style:italic;">Kein Effekt ausgewählt</p>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:15px 0;">
      <div>
        <label style="color:#ccc; display:block; margin:0 0 5px;">📡 Zündbox auswählen:</label>
        <select id="ignitionBox" onchange="selectIgnitionBox()" style="width:100%; padding:10px; background:#333; color:#fff; border:1px solid #555; border-radius:5px;">
          <option value="">Box wählen</option>
          <option value="A">Box A (32 Kanäle)</option>
          <option value="B">Box B (32 Kanäle)</option>
          <option value="C">Box C (32 Kanäle)</option>
          <option value="D">Box D (32 Kanäle)</option>
          <option value="E">Box E (32 Kanäle)</option>
          <option value="F">Box F (32 Kanäle)</option>
        </select>
      </div>
      <div>
        <label style="color:#ccc; display:block; margin:0 0 5px;">🔢 Kanal (1-32):</label>
        <input id="selectedChannel" type="number" min="1" max="32" placeholder="Kanal eingeben" style="width:100%; padding:10px; background:#333; color:#fff; border:1px solid #555; border-radius:5px;">
      </div>
    </div>

    <div style="text-align:center; margin:20px 0;">
      <button onclick="assignToBox()" style="background:#4caf50; color:white; border:none; padding:12px 25px; border-radius:5px; font-size:16px; font-weight:bold;">🎆 Effekt zu Box zuweisen</button>
    </div>

    <div style="margin:20px 0;">
      <h4 style="color:#ff9800; margin:0 0 10px 0;">⚡ Schnell-Zuweisung:</h4>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px,1fr)); gap:8px;">
        <button onclick="quickAssign('A',1)" style="background:#2196f3; color:white; border:none; padding:8px; border-radius:3px; font-size:12px;">A1</button>
        <button onclick="quickAssign('A',2)" style="background:#2196f3; color:white; border:none; padding:8px; border-radius:3px; font-size:12px;">A2</button>
        <button onclick="quickAssign('B',1)" style="background:#2196f3; color:white; border:none; padding:8px; border-radius:3px; font-size:12px;">B1</button>
        <button onclick="quickAssign('B',2)" style="background:#2196f3; color:white; border:none; padding:8px; border-radius:3px; font-size:12px;">B2</button>
        <button onclick="quickAssign('C',1)" style="background:#2196f3; color:white; border:none; padding:8px; border-radius:3px; font-size:12px;">C1</button>
        <button onclick="quickAssign('C',2)" style="background:#2196f3; color:white; border:none; padding:8px; border-radius:3px; font-size:12px;">C2</button>
      </div>
    </div>

    <div style="text-align:center; margin:20px 0;">
      <button onclick="showIgnitionOverview()" style="background:#ff9800; color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; margin:5px;">📋 Zündanlagen-Übersicht anzeigen</button>
      <button onclick="resetBoxPositions()" style="background:#9c27b0; color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; margin:5px;">🔄 Box-Positionen zurücksetzen</button>
    </div>
  </div>

  <div id="ignitionOverview" style="background:#1a2e1a; padding:20px; border-radius:8px; border:2px solid #2e7d32; margin:20px 0; display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="color:#4caf50; margin:0;">📡 Zündanlagen-Übersicht</h3>
      <button onclick="hideIgnitionOverview()" style="background:#666; color:white; border:none; padding:5px 10px; border-radius:3px;">✕ Schließen</button>
    </div>
    <div id="ignitionBoxes"></div>
  </div>

  <h2>🌡️ Wetter-Monitor</h2>
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
    <input id="windSpeed" placeholder="Windgeschwindigkeit (km/h)" type="number">
    <select id="windDirection">
      <option value="">Windrichtung</option>
      <option value="N">Nord</option>
      <option value="NO">Nordost</option>
      <option value="O">Ost</option>
      <option value="SO">Südost</option>
      <option value="S">Süd</option>
      <option value="SW">Südwest</option>
      <option value="W">West</option>
      <option value="NW">Nordwest</option>
    </select>
    <input id="temperature" placeholder="Temperatur (°C)" type="number">
    <input id="humidity" placeholder="Luftfeuchtigkeit (%)" type="number">
    <button onclick="checkWeatherConditions()">🌤️ Wetter prüfen</button>
  </div>
  <div id="weatherStatus" style="margin:10px 0; padding:10px; border-radius:5px; display:none;"></div>

  <div class="controls">
    <button onclick="saveShow()">Show speichern</button>
    <button onclick="loadSavedShows()">Show laden</button>
    <select id="savedShows" onchange="selectShow()">
      <option value="">Gespeicherte Shows</option>
    </select>
    <button onclick="exportShow()">Export JSON</button>
    <input type="file" id="importFile" accept=".json" onchange="importShow(event)">
    <button onclick="printPlan()">Druckversion</button>
    <button onclick="generateQRCode()">📱 Smartphone-Steuerung</button>
    <button onclick="loadFromSession()">🔗 Session laden</button>
    <button onclick="startCollaboration()">👥 Team-Kollaboration</button>
    <button onclick="joinCollaboration()">🤝 Team beitreten</button>
    <button onclick="autoBackup()">💾 Auto-Backup</button>
    <button onclick="startShow()">Show starten</button>
    <button onclick="pauseShow()">Pause</button>
    <button onclick="resumeShow()">Fortsetzen</button>
    <button onclick="stopShow()">Stopp</button>
  </div>
</div>

<!-- Show Screen -->
<div id="showScreen" style="display:none;">
  <h2>Show Timer</h2>
  <div id="timerDisplay">00:00</div>
  <div id="warning"></div>
  <div id="currentEffect">Kein Effekt</div>
  <div id="timelineDisplay"></div>
  <button onclick="backToPlan()" style="margin:20px;">Zurück zur Planung</button>
</div>

<!-- QR Modal & other UI kept minimal for brevity -->
<div id="qrModal" style="display:none;">
  <div class="modal-content"></div>
</div>

<!-- Audio elements (data URIs kept as originals) -->
<audio id="warningBeep" preload="auto"><source src="data:audio/wav;base64,UklGRnoGAABX..." type="audio/wav"></audio>
<audio id="fireBeep" preload="auto"><source src="data:audio/wav;base64,UklGRnoGAABX..." type="audio/wav"></audio>
<audio id="musicPlayer"></audio>

<script>
/* ===========================
   Bereinigtes, robustes Script
   =========================== */

// -------- Globals ----------
let effects = []; // { id, name, time (seconds), timeStr, effectType, price, channel, quantity, x, y, image, video, ... }
let effectDatabase = [];
let showTimer = null;
let showStart = 0;
let pausedOffset = 0;
let isPaused = false;
let audioContext = null;
let beatTimes = [];
let bpm = 0;
let ignitionBoxes = { A:{},B:{},C:{},D:{},E:{},F:{} };
let ignitionBoxPositions = { A:{x:50,y:50},B:{x:150,y:50},C:{x:250,y:50},D:{x:50,y:120},E:{x:150,y:120},F:{x:250,y:120} };
let currentEffectImage = null;
let currentEffectVideo = null;
let intervals = [];
let eventListeners = [];

// -------- Utilities ----------
function escapeHtml(text){ if(!text) return ''; const div=document.createElement('div'); div.textContent = text.toString(); return div.innerHTML; }
function safeParseInt(v,d=0){ const p=parseInt(v); return isNaN(p)?d:p; }
function safeParseFloat(v,d=0){ const p=parseFloat(v); return isNaN(p)?d:p; }
function formatTime(sec){ sec = Math.max(0, Math.floor(sec)); const m = Math.floor(sec/60); const s = sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
function parseTimeString(str){ if(!str) return 0; const parts = str.toString().split(':'); if(parts.length===2){ return safeParseInt(parts[0])*60 + safeParseInt(parts[1]); } return safeParseInt(str); }
function addManagedInterval(fn,delay){ const id = setInterval(fn,delay); intervals.push(id); return id; }
function addManagedEventListener(el,event,cb){ if(!el) return; el.addEventListener(event,cb); eventListeners.push({el,event,cb}); }

// Cleanup on unload
window.addEventListener('beforeunload', ()=>{
  intervals.forEach(i=>clearInterval(i));
  eventListeners.forEach(({el,event,cb})=>{ try{ el.removeEventListener(event,cb);} catch(e){} });
});

// -------- Initialization ----------
window.onload = function(){
  canvas = document.getElementById('fireworkCanvas');
  if(!canvas){ alert('FEHLER: Canvas nicht gefunden'); return; }
  ctx = canvas.getContext('2d');
  loadEffectDatabase();
  loadIgnitionBoxPositions();
  loadSavedShows();
  updateEffectList();
  updateCostCalculation();
  drawCanvas();
  initializeAudioContext();
  setupCanvasHandlers();
  console.log('✅ Initialisierung abgeschlossen');
};

// -------- Audio ----------
function initializeAudioContext(){
  try{ if(typeof AudioContext !== 'undefined') audioContext = new AudioContext(); else if(typeof webkitAudioContext !== 'undefined') audioContext = new webkitAudioContext(); }
  catch(e){ console.warn('AudioContext nicht verfügbar', e); audioContext = null; }
}
function playFireBeep(){
  try{
    const beep = document.getElementById('fireBeep');
    if(beep){
      const p = beep.play();
      if(p && p.catch) p.catch(err => console.warn('Autoplay/Beep blockiert', err));
    }
  }catch(e){ console.warn('Fehler playFireBeep', e); }
}

// -------- Effect Add / Update ----------
function addEffect(){
  try{
    const name = (document.getElementById('name')?.value || '').trim();
    const timeStr = (document.getElementById('time')?.value || '').trim();
    if(!name){ alert('Bitte einen Effektnamen eingeben'); return; }
    if(!timeStr){ alert('Bitte eine Showzeit eingeben (z.B. 1:30)'); return; }
    const time = parseTimeString(timeStr);
    const id = Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,9);
    const effect = {
      id, name, time, timeStr,
      effectType: document.getElementById('effectType')?.value || 'rocket',
      plannedDuration: document.getElementById('plannedDuration')?.value || '',
      price: safeParseFloat(document.getElementById('price')?.value),
      barcode: (document.getElementById('barcode')?.value||'').trim(),
      channel: document.getElementById('channel')?.value || '',
      receiver: document.getElementById('receiver')?.value || '',
      buttonKey: document.getElementById('buttonKey')?.value || '',
      quantity: Math.max(1, safeParseInt(document.getElementById('quantity')?.value,1)),
      additionalInfo: document.getElementById('additionalInfo')?.value || '',
      image: currentEffectImage || null,
      video: currentEffectVideo || null,
      x: null, y: null,
      createdAt: new Date().toISOString()
    };
    effects.push(effect);
    updateEffectList();
    updateCostCalculation();
    drawCanvas();
    showSuccessMessage(`Effekt "${escapeHtml(name)}" hinzugefügt`);
    // clear minimal fields
    document.getElementById('name').value=''; document.getElementById('time').value='';
    clearImage(); clearVideo();
  }catch(e){ console.error('addEffect error', e); alert('Fehler beim Hinzufügen des Effekts'); }
}

function updateEffectList(){
  try{
    const list = document.getElementById('effectList');
    if(!list) return;
    list.innerHTML = '<h3>Effekte in der Show</h3>';
    if(!Array.isArray(effects) || effects.length===0){ list.innerHTML += '<p style="color:#666; font-style:italic;">Keine Effekte</p>'; return; }
    effects.sort((a,b)=> (a.time||0)-(b.time||0));
    effects.forEach(effect=>{
      if(!effect || !effect.id) return;
      const div = document.createElement('div');
      div.className='effect-item';
      div.setAttribute('data-effect-id', effect.id);
      const safeName = escapeHtml(effect.name||'Unbenannt');
      const safeTime = escapeHtml(effect.timeStr||formatTime(effect.time||0));
      const safeType = escapeHtml(effect.effectType||'rocket');
      const price = (effect.price>0)? safeParseFloat(effect.price).toFixed(2) : '0.00';
      const stockText = '';
      const posText = (effect.x!==null && effect.y!==null) ? `X:${Math.round(effect.x)}, Y:${Math.round(effect.y)}` : 'Nicht platziert';
      div.innerHTML = `
        <div style="display:flex; align-items:center;">
          ${effect.image? `<img src="${effect.image}" class="effect-image" alt="Effekt" onerror="this.style.display='none';">` : ''}
          ${effect.video? `<video src="${effect.video}" class="effect-video" muted onerror="this.style.display='none';"></video>` : ''}
          <div>
            <strong>${safeName}</strong><br>
            Zeit: ${safeTime} | Typ: ${safeType}<br>
            Kanal: ${escapeHtml(effect.channel || 'Nicht gesetzt')} | Taste: ${escapeHtml(effect.buttonKey || 'Nicht gesetzt')}<br>
            Preis: ${price}€ | Anzahl: ${effect.quantity || 1}<br>
            Position: ${posText}${stockText}
          </div>
        </div>
        <div style="display:flex; gap:5px;">
          <button onclick="selectEffectForIgnition('${effect.id}')" title="Zu Zündanlage zuweisen" style="background:#ff9800; color:white; border:none; padding:5px 8px; border-radius:3px;">📡</button>
          <button onclick="editEffect('${effect.id}')" style="background:#2196f3; color:white; border:none; padding:5px 8px; border-radius:3px;">✏️</button>
          <button onclick="deleteEffect('${effect.id}')" class="effect-delete">×</button>
        </div>
      `;
      // drag handlers for canvas placement
      div.draggable = true;
      div.addEventListener('dragstart', ()=> { draggedEffect = effect; div.classList.add('dragging'); });
      div.addEventListener('dragend', ()=> { draggedEffect = null; div.classList.remove('dragging'); });
      list.appendChild(div);
    });
  }catch(e){ console.error('updateEffectList', e); }
}

function deleteEffect(id){
  try{
    if(!confirm('Effekt wirklich löschen?')) return;
    const oldLen = effects.length;
    effects = effects.filter(e=> e && e.id !== id);
    if(effects.length === oldLen-1){
      updateEffectList(); updateCostCalculation(); drawCanvas(); showSuccessMessage('Effekt gelöscht');
    } else alert('Fehler beim Löschen');
  }catch(e){ console.error('deleteEffect', e); alert('Fehler beim Löschen'); }
}

// Minimal edit placeholder (keine Modal, nur füllt Felder)
function editEffect(id){
  try{
    const e = effects.find(x=>x.id===id);
    if(!e) { alert('Effekt nicht gefunden'); return; }
    document.getElementById('name').value = e.name || '';
    document.getElementById('time').value = e.timeStr || formatTime(e.time||0);
    document.getElementById('price').value = e.price || '';
    document.getElementById('plannedDuration').value = e.plannedDuration || '';
    document.getElementById('effectType').value = e.effectType || 'rocket';
    currentEffectImage = e.image || null;
    if(currentEffectImage) document.getElementById('imagePreview').innerHTML = `<img src="${currentEffectImage}" class="image-preview">`;
    currentEffectVideo = e.video || null;
    if(currentEffectVideo) document.getElementById('videoPreview').innerHTML = `<video class="video-preview" controls muted><source src="${currentEffectVideo}"></video>`;
    // Remove the old effect so 'save' behaves like update
    effects = effects.filter(x=>x.id !== id);
    updateEffectList();
  }catch(e){ console.error('editEffect', e); alert('Fehler beim Bearbeiten'); }
}

// -------- Cost / Overview ----------
function updateCostCalculation(){
  try{
    let totalCost = 0; let totalEffects = 0;
    if(Array.isArray(effects)) effects.forEach(effect=>{ if(effect){ totalCost += (safeParseFloat(effect.price) * (effect.quantity||1)); totalEffects += (effect.quantity||1); }});
    const totalCostElement = document.getElementById('totalCost');
    const effectCountElement = document.getElementById('effectCount');
    if(totalCostElement) totalCostElement.textContent = `Gesamtkosten: ${totalCost.toFixed(2)} €`;
    if(effectCountElement) effectCountElement.textContent = `Anzahl Effekte: ${totalEffects}`;
    updateEffectOverview();
  }catch(e){ console.error('updateCostCalculation', e); }
}

function updateEffectOverview(){
  try{
    const overviewDiv = document.getElementById('overviewTable');
    if(!overviewDiv) return;
    if(!Array.isArray(effects) || effects.length===0){ overviewDiv.innerHTML = '<p style="color:#666; font-style:italic;">Keine Effekte in der Show</p>'; return; }
    const sortedEffects = [...effects].sort((a,b)=>(a.time||0)-(b.time||0));
    let html = `<table class="overview-table"><thead><tr><th>Zeit</th><th>Effekt</th><th>Typ</th><th>Dauer</th><th>Kanal</th><th>Taste</th><th>Empfänger</th><th>Preis</th><th>Anzahl</th></tr></thead><tbody>`;
    sortedEffects.forEach(effect=>{
      const safeName = escapeHtml(effect.name||'Unbenannt');
      const safeTime = escapeHtml(effect.timeStr || formatTime(effect.time||0));
      const safeType = escapeHtml(effect.effectType||'rocket');
      const safeDuration = escapeHtml(effect.plannedDuration || '-');
      const safeChannel = escapeHtml(effect.channel || '-');
      const safeButtonKey = escapeHtml(effect.buttonKey || '-');
      const safeReceiver = escapeHtml(effect.receiver || '-');
      const safePrice = (effect.price && effect.price>0)? safeParseFloat(effect.price).toFixed(2)+'€' : '-';
      const safeQuantity = Math.max(1, safeParseInt(effect.quantity,1));
      html += `<tr><td>${safeTime}</td><td><strong>${safeName}</strong></td><td>${safeType}</td><td>${safeDuration}</td><td>${safeChannel}</td><td>${safeButtonKey}</td><td>${safeReceiver}</td><td>${safePrice}</td><td>${safeQuantity}</td></tr>`;
    });
    html += `</tbody></table>`;
    overviewDiv.innerHTML = html;
  }catch(e){ console.error('updateEffectOverview', e); }
}

// -------- Canvas draw & handlers ----------
let canvas, ctx, draggedEffect = null, isDraggingBox=false, draggedBox=null, dragOffset={x:0,y:0};

function drawCanvas(){
  try{
    if(!ctx) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // draw background grid
    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // draw ignition boxes
    Object.keys(ignitionBoxPositions).forEach(boxName=>{
      const pos = ignitionBoxPositions[boxName];
      ctx.fillStyle = '#2a2a2a';
      ctx.fillRect(pos.x-25, pos.y-15, 50, 30);
      ctx.strokeStyle = '#666';
      ctx.strokeRect(pos.x-25, pos.y-15, 50, 30);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px Arial';
      ctx.fillText(boxName, pos.x-8, pos.y+4);
    });

    // draw effects on canvas
    effects.forEach(effect=>{
      if(effect.x!=null && effect.y!=null){
        try{
          ctx.fillStyle = '#ff9800';
          ctx.beginPath();
          ctx.arc(effect.x, effect.y, 8, 0, Math.PI*2);
          ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.font = '10px Arial';
          ctx.fillText(effect.name.substring(0,12), effect.x+12, effect.y+4);
        }catch(e){ console.warn('draw effect error', e); }
      }
    });

    // show unplaced hint
    const unplaced = effects.filter(e=> e.x==null || e.y==null);
    if(unplaced.length>0){
      ctx.fillStyle = '#ffff00';
      ctx.font = 'bold 16px Arial';
      ctx.fillText(`${unplaced.length} Effekt(e) noch nicht platziert`, 20, 30);
      ctx.font='14px Arial';
      ctx.fillText('Klicke auf das Abbrennfeld um sie zu platzieren', 20, 50);
      if(unplaced[0]){ ctx.fillStyle='#ff8800'; ctx.fillText(`Nächster: "${escapeHtml(unplaced[0].name||'Effekt')}"`, 20,70); }
    }

  }catch(e){ console.error('drawCanvas', e); }
}

function setupCanvasHandlers(){
  if(!canvas) return;
  addManagedEventListener(canvas, 'click', function(e){
    try{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      // click on ignition boxes?
      let clickedBox = null;
      Object.keys(ignitionBoxPositions).forEach(b=>{
        const p = ignitionBoxPositions[b];
        if(x>=p.x-25 && x<=p.x+25 && y>=p.y-15 && y<=p.y+15) clickedBox = b;
      });
      if(clickedBox){ showIgnitionBoxDetails(clickedBox); return; }
      // place first unplaced effect
      const unplaced = effects.find(effect => effect.x==null || effect.y==null);
      if(unplaced){
        unplaced.x = x; unplaced.y = y;
        updateEffectList(); drawCanvas(); showSuccessMessage(`"${escapeHtml(unplaced.name)}" platziert`);
      }
    }catch(err){ console.error('canvas click', err); }
  });

  addManagedEventListener(canvas, 'mousedown', function(e){
    try{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      Object.keys(ignitionBoxPositions).forEach(boxName=>{
        const p = ignitionBoxPositions[boxName];
        if(x>=p.x-25 && x<=p.x+25 && y>=p.y-15 && y<=p.y+15){
          draggedBox = boxName; isDraggingBox = true; dragOffset.x = x - p.x; dragOffset.y = y - p.y; canvas.style.cursor='grabbing';
        }
      });
    }catch(e){ console.warn('mousedown', e); }
  });

  addManagedEventListener(canvas, 'mousemove', function(e){
    try{
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      if(isDraggingBox && draggedBox){
        ignitionBoxPositions[draggedBox].x = Math.max(25, Math.min(canvas.width-25, x - dragOffset.x));
        ignitionBoxPositions[draggedBox].y = Math.max(15, Math.min(canvas.height-15, y - dragOffset.y));
        drawCanvas();
      }
    }catch(e){ console.warn('mousemove', e); }
  });

  addManagedEventListener(canvas, 'mouseup', function(e){
    try{
      if(isDraggingBox && draggedBox){
        try{ localStorage.setItem('ignitionBoxPositions', JSON.stringify(ignitionBoxPositions)); } catch(e){ console.warn('save ignition positions', e); }
        showSuccessMessage(`Box ${draggedBox} verschoben`);
      }
      isDraggingBox=false; draggedBox=null; canvas.style.cursor='crosshair';
    }catch(e){ console.warn('mouseup', e); }
  });

  // drag/drop for items (from list)
  addManagedEventListener(canvas, 'dragover', function(e){ e.preventDefault(); });
  addManagedEventListener(canvas, 'drop', function(e){
    e.preventDefault();
    if(draggedEffect){
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX-rect.left; const y = e.clientY-rect.top;
      draggedEffect.x = x; draggedEffect.y = y; draggedEffect = null;
      updateEffectList(); drawCanvas();
    }
  });
}

// -------- DataBase / Import / Export ----------
function loadEffectDatabase(){
  try{
    const saved = localStorage.getItem('effectDatabase');
    effectDatabase = saved ? JSON.parse(saved) : [];
    updateDatabaseList();
  }catch(e){ console.warn('loadEffectDatabase', e); effectDatabase=[]; updateDatabaseList(); }
}

function updateDatabaseList(){
  try{
    const select = document.getElementById('effectDatabase');
    if(!select) return;
    select.innerHTML = '';
    const opt = document.createElement('option'); opt.value=''; opt.textContent=`📊 Effekt-Datenbank (${effectDatabase.length} Effekte)`; select.appendChild(opt);
    effectDatabase.forEach((ef,i)=>{
      const o = document.createElement('option'); o.value = i.toString();
      const safeName = escapeHtml(ef.name || 'Unbenannt');
      o.textContent = `${safeName}${ef.price? ' - '+safeParseFloat(ef.price).toFixed(2)+'€':''}${(typeof ef.stockQuantity==='number')? ' ('+ef.stockQuantity+'x)':''}`;
      select.appendChild(o);
    });
  }catch(e){ console.warn('updateDatabaseList', e); }
}

function addToDatabase(){
  try{
    const name = (document.getElementById('name')?.value||'').trim();
    if(!name) { alert('Bitte Effektname eingeben'); return; }
    const entry = {
      name,
      barcode: (document.getElementById('barcode')?.value||'').trim(),
      duration: (document.getElementById('plannedDuration')?.value||'').trim(),
      price: safeParseFloat(document.getElementById('price')?.value),
      effectType: document.getElementById('effectType')?.value || 'rocket',
      stockQuantity: safeParseInt(document.getElementById('stockQuantity')?.value, 0),
      image: currentEffectImage || null,
      video: currentEffectVideo || null
    };
    effectDatabase.push(entry);
    try{ localStorage.setItem('effectDatabase', JSON.stringify(effectDatabase)); } catch(e){ console.warn('save db', e); }
    updateDatabaseList(); showSuccessMessage('Effekt zur Datenbank hinzugefügt');
  }catch(e){ console.error('addToDatabase', e); alert('Fehler beim Hinzufügen zur DB'); }
}

// Excel/CSV import (simple)
function importExcelDatabase(){
  try{
    const f = document.getElementById('excelImport');
    if(!f || !f.files || !f.files[0]) { alert('Bitte eine Datei auswählen'); return; }
    const file = f.files[0];
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const text = ev.target.result;
        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
        const db = [];
        for(const line of lines){
          const parts = line.split(/[\|;\t,]/).map(p=>p.trim());
          if(parts.length < 1) continue;
          db.push({ name: parts[0]||'', barcode: parts[1]||'', duration: parts[2]||'', price: parseFloat(parts[3])||0, effectType: parts[4]||'', stockQuantity: parseInt(parts[5])||0 });
        }
        effectDatabase = (effectDatabase||[]).concat(db);
        localStorage.setItem('effectDatabase', JSON.stringify(effectDatabase));
        updateDatabaseList();
        alert('Excel/CSV importiert: ' + db.length + ' Einträge');
      }catch(e){ alert('Fehler beim Import: '+e.message); }
    };
    reader.readAsText(file);
  }catch(e){ console.error('importExcelDatabase', e); }
}

function clearDatabase(){
  if(!confirm('Datenbank wirklich leeren?')) return;
  effectDatabase = [];
  try{ localStorage.removeItem('effectDatabase'); } catch(e){ console.warn('clear db', e); }
  updateDatabaseList();
  showSuccessMessage('Datenbank geleert');
}

// -------- Import/Export Show (FIXED) ----------
function exportShow(){
  try{
    const data = { name: (document.getElementById('showName')?.value||'show'), effects: effects || [] };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=(data.name.replace(/\s+/g,'_')||'show')+'.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }catch(e){ console.error('exportShow', e); alert('Export fehlgeschlagen'); }
}

function importShow(event){
  try{
    const fileInput = (event && event.target) ? event.target : document.getElementById('importFile');
    const f = fileInput?.files?.[0];
    if(!f) { alert('Bitte JSON-Datei wählen'); return; }
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const obj = JSON.parse(ev.target.result);
        if(!obj || !Array.isArray(obj.effects)){
          alert('❌ Importierte Datei enthält keine gültigen Effekte!');
          return;
        }
        // Validate structure: ensure name & time exist (or map)
        const validated = obj.effects.map((x, idx) => {
          const name = x.name || x.title || ('Effekt_'+(idx+1));
          const time = (typeof x.time === 'number') ? x.time : (x.timeStr? parseTimeString(x.timeStr) : (x.seconds || 0));
          const timeStr = x.timeStr || formatTime(time);
          return { ...x, name, time, timeStr, id: x.id || (Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6)) };
        }).filter(e=> e && e.name && (typeof e.time === 'number'));
        effects = validated;
        updateEffectList(); updateCostCalculation(); drawCanvas(); alert('✅ Show erfolgreich importiert!');
      }catch(parseError){ console.error('importShow parse', parseError); alert('Fehler beim Lesen der Datei: '+parseError.message); }
    };
    reader.readAsText(f);
  }catch(e){ console.error('importShow', e); alert('Import fehlgeschlagen'); }
}

// -------- Show control (single, robust implementation) ----------
function startShow(){
  try{
    if(!Array.isArray(effects) || effects.length===0){ alert('Keine Effekte in der Show.'); return; }
    // Validate effect times
    effects = effects.map(e => ({ ...e, time: (typeof e.time==='number'? e.time : parseTimeString(e.timeStr || e.time || 0)), timeStr: e.timeStr || formatTime(e.time||0) }));
    effects.sort((a,b)=> (a.time||0)-(b.time||0));
    // Reset previous timer
    if(showTimer) { clearInterval(showTimer); showTimer=null; }
    showStart = Date.now(); pausedOffset = 0; isPaused = false;
    document.getElementById('planScreen').style.display='none';
    document.getElementById('showScreen').style.display='block';
    let currentIndex = 0;
    function tick(){
      if(isPaused) return;
      const elapsed = Math.floor((Date.now()-showStart)/1000) + pausedOffset;
      document.getElementById('timerDisplay').textContent = formatTime(elapsed);
      // find and fire all effects that are due (in case of big jumps)
      while(currentIndex < effects.length && (effects[currentIndex].time || 0) <= elapsed){
        const cur = effects[currentIndex];
        if(cur){
          document.getElementById('currentEffect').textContent = `${cur.timeStr} — ${cur.name}`;
          playFireBeep();
          // (Here you could trigger visual explosion, send ignition, etc.)
        }
        currentIndex++;
      }
      if(currentIndex >= effects.length){
        clearInterval(showTimer); showTimer = null;
        document.getElementById('currentEffect').textContent = '✅ Show beendet!';
        // Auto-return to plan after short delay
        setTimeout(()=>{ stopShow(); }, 2500);
      }
    }
    tick();
    showTimer = setInterval(tick, 500);
  }catch(e){ console.error('startShow error', e); alert('Fehler beim Starten'); }
}

function pauseShow(){
  if(!showTimer) return;
  clearInterval(showTimer); showTimer=null;
  pausedOffset = Math.floor((Date.now()-showStart)/1000) + pausedOffset;
  isPaused = true;
  if(document.getElementById('warning')) document.getElementById('warning').textContent = 'PAUSE';
}

function resumeShow(){
  if(showTimer) return;
  showStart = Date.now();
  isPaused = false;
  if(document.getElementById('warning')) document.getElementById('warning').textContent = '';
  // resume tick loop
  let lastIndex = 0;
  // find how many effects already elapsed
  const elapsed = pausedOffset;
  for(let i=0;i<effects.length;i++){ if((effects[i].time||0) <= elapsed) lastIndex = i+1; else break; }
  // start new interval which uses pausedOffset + (Date.now()-showStart)
  showTimer = setInterval(function(){
    const elapsedNow = Math.floor((Date.now()-showStart)/1000) + pausedOffset;
    document.getElementById('timerDisplay').textContent = formatTime(elapsedNow);
    // similar firing logic as startShow (simplified)
    // find and handle due effects
    while(lastIndex < effects.length && (effects[lastIndex].time||0) <= elapsedNow){
      const cur = effects[lastIndex];
      if(cur){ document.getElementById('currentEffect').textContent = `${cur.timeStr} — ${cur.name}`; playFireBeep(); }
      lastIndex++;
    }
    if(lastIndex >= effects.length){ clearInterval(showTimer); showTimer=null; document.getElementById('currentEffect').textContent = '✅ Show beendet!'; setTimeout(()=>stopShow(),2500); }
  }, 500);
}

function stopShow(){
  try{
    if(showTimer){ clearInterval(showTimer); showTimer=null; }
    showStart = 0; pausedOffset = 0; isPaused = false;
    if(document.getElementById('showScreen')) document.getElementById('showScreen').style.display='none';
    if(document.getElementById('planScreen')) document.getElementById('planScreen').style.display='block';
    if(document.getElementById('timerDisplay')) document.getElementById('timerDisplay').textContent='00:00';
    if(document.getElementById('currentEffect')) document.getElementById('currentEffect').textContent='Kein Effekt';
    if(document.getElementById('warning')) document.getElementById('warning').textContent='';
    showSuccessMessage('Show gestoppt');
  }catch(e){ console.error('stopShow', e); }
}

function backToPlan(){ stopShow(); }

// -------- Ignition / Boxes ----------
function selectEffectForIgnition(id){
  const el = effects.find(e=>e.id===id);
  if(!el) return alert('Effekt nicht gefunden');
  selectedEffect = el;
  updateCurrentSelectionUI();
}

let selectedEffect = null;
function updateCurrentSelectionUI(){
  const div = document.getElementById('currentSelection');
  if(!div) return;
  if(selectedEffect){
    div.innerHTML = `<div style="color:#4caf50;"><strong>🎆 ${escapeHtml(selectedEffect.name||'Effekt')}</strong><br><span style="color:#ccc;">Zeit: ${escapeHtml(selectedEffect.timeStr||'0:00')}</span><br><span style="color:#ff9800;">${(selectedEffect.ignitionBox && selectedEffect.ignitionChannel) ? `📡 Box ${escapeHtml(selectedEffect.ignitionBox)}-${escapeHtml(selectedEffect.ignitionChannel)}` : '📡 Noch nicht zugewiesen'}</span></div>`;
  } else {
    div.innerHTML = '<p style="color:#666; font-style:italic;">Kein Effekt ausgewählt</p>';
  }
}

function assignToBox(){
  try{
    if(!selectedEffect) { alert('Bitte zuerst einen Effekt auswählen (📡 neben dem Effekt).'); return; }
    const box = document.getElementById('ignitionBox')?.value;
    const channel = safeParseInt(document.getElementById('selectedChannel')?.value, 0);
    if(!box || channel < 1 || channel > 32){ alert('Bitte gültige Box und Kanal wählen (1-32)'); return; }
    // assign
    ignitionBoxes[box] = ignitionBoxes[box] || {};
    ignitionBoxes[box][String(channel)] = selectedEffect;
    selectedEffect.ignitionBox = box; selectedEffect.ignitionChannel = String(channel);
    updateEffectList(); updateCurrentSelectionUI(); showSuccessMessage(`Effekt zu Box ${box}-${channel} zugewiesen`);
  }catch(e){ console.error('assignToBox', e); alert('Fehler bei Zuweisung'); }
}

function quickAssign(box, channel){ document.getElementById('ignitionBox').value = box; document.getElementById('selectedChannel').value = channel; assignToBox(); }

function showIgnitionOverview(){
  const el = document.getElementById('ignitionOverview'); if(!el) return;
  el.style.display = 'block';
  const boxesDiv = document.getElementById('ignitionBoxes');
  if(!boxesDiv) return;
  let html = '';
  Object.keys(ignitionBoxes).forEach(b=>{
    html += `<div style="background:#222; padding:10px; margin:5px; border-radius:5px;"><h4>Box ${b}</h4>`;
    const box = ignitionBoxes[b]||{};
    const keys = Object.keys(box).sort((a,b)=>parseInt(a)-parseInt(b));
    if(keys.length===0) html += '<p style="color:#ccc;">Keine Effekte zugewiesen</p>';
    else {
      keys.forEach(k=>{
        const ef = box[k];
        html += `<div style="border-top:1px solid #444; padding-top:6px; margin-top:6px;">Kanal ${k}: <strong>${escapeHtml(ef.name||'')}</strong> (${escapeHtml(ef.timeStr||formatTime(ef.time||0))})</div>`;
      });
    }
    html += '</div>';
  });
  boxesDiv.innerHTML = html;
}

function hideIgnitionOverview(){ const el=document.getElementById('ignitionOverview'); if(el) el.style.display='none'; }
function showIgnitionBoxDetails(boxName){
  try{
    const box = ignitionBoxes[boxName] || {};
    let msg = `📡 Zündbox ${boxName}\nBelegte Kanäle: ${Object.keys(box).length}/32\n`;
    if(Object.keys(box).length===0) msg += '\nKeine Effekte zugewiesen';
    else {
      Object.keys(box).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(ch=>{
        const ef = box[ch];
        msg += `\nKanal ${ch}: ${ef.name} — Zeit: ${ef.timeStr||formatTime(ef.time||0)}`;
      });
    }
    alert(msg);
    showIgnitionOverview();
  }catch(e){ console.error('showIgnitionBoxDetails', e); alert('Fehler beim Anzeigen'); }
}

function resetBoxPositions(){
  if(!confirm('🔄 Zündbox-Positionen auf Standard zurücksetzen?')) return;
  ignitionBoxPositions = { A:{x:50,y:50},B:{x:150,y:50},C:{x:250,y:50},D:{x:50,y:120},E:{x:150,y:120},F:{x:250,y:120} };
  try{ localStorage.setItem('ignitionBoxPositions', JSON.stringify(ignitionBoxPositions)); }catch(e){ console.warn('save box pos', e); }
  drawCanvas();
  showSuccessMessage('Zündbox-Positionen zurückgesetzt');
}

function loadIgnitionBoxPositions(){
  try{
    const s = localStorage.getItem('ignitionBoxPositions');
    if(s){ const parsed = JSON.parse(s); Object.keys(ignitionBoxPositions).forEach(b=>{ if(parsed[b] && typeof parsed[b].x==='number') ignitionBoxPositions[b] = parsed[b]; }); }
  }catch(e){ console.warn('loadIgnitionBoxPositions', e); }
}

// -------- Image / Video preview ----------
function previewImage(){
  try{
    const fi = document.getElementById('effectImage');
    const file = fi?.files?.[0];
    const preview = document.getElementById('imagePreview');
    if(!preview) return;
    if(file){
      const reader = new FileReader();
      reader.onload = function(e){ currentEffectImage = e.target.result; preview.innerHTML = `<img src="${currentEffectImage}" class="image-preview">`; };
      reader.readAsDataURL(file);
    } else clearImage();
  }catch(e){ console.warn('previewImage', e); }
}
function clearImage(){ currentEffectImage = null; const p = document.getElementById('imagePreview'); if(p) p.innerHTML=''; const fi=document.getElementById('effectImage'); if(fi) fi.value=''; }
function previewVideo(){ try{
  const fi = document.getElementById('effectVideo'); const file = fi?.files?.[0]; const pv = document.getElementById('videoPreview');
  if(!pv) return;
  if(file){ const reader = new FileReader(); reader.onload = function(e){ currentEffectVideo = e.target.result; pv.innerHTML = `<video class="video-preview" controls muted><source src="${currentEffectVideo}"></video>`; }; reader.readAsDataURL(file); } else clearVideo();
}catch(e){ console.warn('previewVideo', e); } }
function clearVideo(){ currentEffectVideo = null; const p=document.getElementById('videoPreview'); if(p) p.innerHTML=''; const fi=document.getElementById('effectVideo'); if(fi) fi.value=''; }

// -------- Misc placeholders (kept, but robust) ----------
function saveShow(){ try{ const name = (document.getElementById('showName')?.value)||('show_'+new Date().toISOString()); const key = 'savedShows_legacy_v1'; const all = JSON.parse(localStorage.getItem(key)||'{}'); all[name] = { name, effects, savedAt: new Date().toISOString() }; localStorage.setItem(key, JSON.stringify(all)); alert('Show gespeichert: '+name); loadSavedShows(); }catch(e){ alert('Fehler speichern: '+e.message); } }
function loadSavedShows(){ try{ const sel = document.getElementById('savedShows'); if(!sel) return; sel.innerHTML = '<option value=\"\">Gespeicherte Shows</option>'; const key='savedShows_legacy_v1'; const all = JSON.parse(localStorage.getItem(key)||'{}'); Object.keys(all).forEach(k=>{ const opt = document.createElement('option'); opt.value=k; opt.textContent=k + ' • ' + (all[k].savedAt||''); sel.appendChild(opt); }); }catch(e){ console.warn('loadSavedShows', e); } }
function selectShow(){ try{ const k = document.getElementById('savedShows')?.value; if(!k) return; const all = JSON.parse(localStorage.getItem('savedShows_legacy_v1')||'{}'); if(all[k]){ effects = all[k].effects || []; updateEffectList(); updateCostCalculation(); drawCanvas(); document.getElementById('showName').value = all[k].name || ''; showSuccessMessage('Show geladen'); } }catch(e){ console.warn('selectShow', e); } }
function generateQRCode(){ alert('QR-Funktion: vorerst Platzhalter'); }
function loadFromSession(){ alert('Session laden: Platzhalter'); }
function startCollaboration(){ alert('Kollaboration: Platzhalter'); }
function joinCollaboration(){ alert('Kollaboration beitreten: Platzhalter'); }
function autoBackup(){ try{ localStorage.setItem('lastBackup', JSON.stringify({ effects, at: new Date().toISOString() })); showSuccessMessage('Backup erstellt'); }catch(e){ console.warn('autoBackup', e); } }
function analyzeBeat(){ alert('Beat-Analyse: Platzhalter'); }
function autoSyncEffects(){ alert('Auto-Sync: Platzhalter'); }
function checkWeatherConditions(){ try{ const ws = document.getElementById('windSpeed')?.value; const dir = document.getElementById('windDirection')?.value; const t = document.getElementById('temperature')?.value; const h = document.getElementById('humidity')?.value; const s=document.getElementById('weatherStatus'); if(!s) return; s.style.display='block'; s.textContent = `Wind: ${ws||'n/a'} km/h ${dir||''}, Temp: ${t||'n/a'} °C, Humidity: ${h||'n/a'}%`; }catch(e){ console.warn('checkWeatherConditions', e); } }
function selectFromDatabase(){ try{ const sel = document.getElementById('effectDatabase'); const val = sel?.value; if(!val) return; const idx = parseInt(val); if(isNaN(idx) || !effectDatabase[idx]) return; const ef = effectDatabase[idx]; document.getElementById('name').value = ef.name||''; document.getElementById('plannedDuration').value = ef.duration||''; document.getElementById('price').value = ef.price||''; document.getElementById('barcode').value = ef.barcode||''; document.getElementById('stockQuantity').value = ef.stockQuantity||''; if(ef.image){ currentEffectImage = ef.image; document.getElementById('imagePreview').innerHTML = `<img src="${ef.image}" class="image-preview">`; } if(ef.video){ currentEffectVideo = ef.video; document.getElementById('videoPreview').innerHTML = `<video class="video-preview" controls muted><source src="${ef.video}"></video>`; } showSuccessMessage('Effekt aus DB geladen'); }catch(e){ console.warn('selectFromDatabase', e); } }
function selectSavedEffect(){ alert('selectSavedEffect: Platzhalter'); }
function showSearch(){ const s = document.getElementById('effectSearch'); if(s) s.style.display='inline-block'; }
function hideSearch(){ const s=document.getElementById('effectSearch'); if(s) s.style.display='none'; }
function searchEffects(){ alert('searchEffects: Platzhalter'); }

// -------- small helpers ----------
function showSuccessMessage(message, duration=2500){
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:linear-gradient(45deg,#4caf50,#66bb6a); color:white; padding:12px 20px; border-radius:8px; z-index:10000; font-weight:bold;';
  div.textContent = message;
  document.body.appendChild(div);
  setTimeout(()=>{ div.style.opacity='0'; setTimeout(()=>{ if(div.parentNode) div.parentNode.removeChild(div); },300); }, duration);
}

// -------- minimal draw on load
// drawCanvas() called after initial loads in onload

</script>

</body>
</html>
