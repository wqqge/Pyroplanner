<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>🎉 FirePlanner 2D - Pro Advanced (Korrigiert)</title>
<style>
body {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
  margin: 0;
  background: #111;
  color: #eee;
}
h1, h2 {
  text-align: center;
  margin: 10px 0;
}
input, button, select, textarea {
  margin: 5px;
  padding: 8px;
  background: #222;
  color: #fff;
  border: 1px solid #555;
  border-radius: 5px;
  font-size: 14px;
  outline: none;
}

input:focus, textarea:focus, select:focus {
  background: #333;
  border-color: #4caf50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
}

input[type="text"], input[type="number"], textarea {
  width: 200px;
  max-width: 100%;
}
button {
  cursor: pointer;
  background: #444;
  transition: 0.2s;
  padding: 10px 15px;
}
button:hover {
  background: #666;
}
#container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
}
#effectList {
  max-width: 400px;
  margin: 10px;
}
.effect-item {
  border: 1px solid #555;
  padding: 10px;
  margin: 8px 0;
  border-radius: 5px;
  background: #222;
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}
.effect-item:hover {
  background: #333;
  transform: translateY(-2px);
}
.effect-item.dragging {
  opacity: 0.5;
  transform: rotate(5deg);
}
.effect-item.low-stock {
  border-color: #ff9800;
  background: #2d1b0f;
}
.effect-item.out-of-stock {
  border-color: #f44336;
  background: #2d0f0f;
}
#canvasContainer {
  position: relative;
  margin: 10px auto;
  border: 2px solid #555;
  background: #000;
  border-radius: 8px;
}
#fireworkCanvas {
  cursor: crosshair;
  display: block;
  border-radius: 6px;
}
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background: #333;
  color: #fff;
  text-align: left;
  border-radius: 5px;
  padding: 8px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
#timerDisplay {
  font-size: 3em;
  text-align: center;
  margin: 20px 0;
  font-weight: bold;
  color: #0ff;
}
#currentEffect {
  font-size: 1.4em;
  color: #ff0;
  text-align: center;
  margin: 15px 0;
  padding: 10px;
  background: #222;
  border-radius: 5px;
  min-height: 60px;
}
#warning {
  font-size: 2.5em;
  color: #f00;
  text-align: center;
  margin: 15px 0;
  font-weight: bold;
}
#timelineDisplay {
  text-align: center;
  margin: 15px 0;
  padding: 10px;
  background: #222;
  border-radius: 5px;
}
#printArea {
  display: none;
}
#warningFlash {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: red;
  opacity: 0;
  pointer-events: none;
  border-radius: 5px;
  transition: opacity 0.1s;
}
.controls {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #222;
  border-radius: 8px;
}
.effect-delete {
  background: #d32f2f;
  color: white;
  border: none;
  padding: 5px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}
.effect-delete:hover {
  background: #b71c1c;
}
#costCalculation {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #1a4d1a;
  border-radius: 8px;
  border: 2px solid #2e7d32;
}
#costCalculation h3 {
  margin: 0 0 10px 0;
  color: #4caf50;
}
#totalCost {
  font-size: 1.5em;
  font-weight: bold;
  color: #81c784;
}
#effectCount {
  color: #a5d6a7;
  margin-top: 5px;
}
.explosion {
  position: absolute;
  pointer-events: none;
  border-radius: 50%;
  animation: explode 1s ease-out forwards;
}
@keyframes explode {
  0% { transform: scale(0); opacity: 1; }
  50% { transform: scale(1.5); opacity: 0.8; }
  100% { transform: scale(3); opacity: 0; }
}
#qrModal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
}
.modal-content {
  background-color: #222;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #555;
  border-radius: 10px;
  width: 300px;
  text-align: center;
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover {
  color: #fff;
}
#backupStatus {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 10px;
  border-radius: 5px;
  display: none;
  z-index: 1000;
}
#effectOverview {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #1a1a2e;
  border-radius: 8px;
  border: 2px solid #16213e;
}
#effectOverview h3 {
  margin: 0 0 15px 0;
  color: #0f3460;
}
#overviewTable {
  overflow-x: auto;
}
.overview-table {
  width: 100%;
  border-collapse: collapse;
  background: #222;
  border-radius: 5px;
  overflow: hidden;
}
.overview-table th {
  background: #333;
  color: #fff;
  padding: 10px 8px;
  text-align: left;
  font-size: 12px;
  border-bottom: 2px solid #555;
}
.overview-table td {
  padding: 8px;
  border-bottom: 1px solid #444;
  font-size: 11px;
  color: #ddd;
}
.overview-table tr:hover {
  background: #2a2a2a;
}
.time-cell {
  color: #4caf50;
  font-weight: bold;
}
.channel-cell {
  color: #2196f3;
  font-weight: bold;
}
.button-cell {
  color: #ff9800;
  font-weight: bold;
}
.database-info {
  background: #2a2a2a;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  font-size: 12px;
  color: #ccc;
}
.image-preview {
  max-width: 200px;
  max-height: 150px;
  border-radius: 5px;
  border: 2px solid #555;
  margin: 10px 0;
}
.video-preview {
  max-width: 200px;
  max-height: 150px;
  border-radius: 5px;
  border: 2px solid #555;
  margin: 10px 0;
}
.effect-image {
  max-width: 50px;
  max-height: 50px;
  border-radius: 3px;
  margin-right: 10px;
  vertical-align: middle;
}
.effect-video {
  max-width: 50px;
  max-height: 50px;
  border-radius: 3px;
  margin-right: 10px;
  vertical-align: middle;
}
.database-item {
  display: flex;
  align-items: center;
  padding: 5px;
  margin: 2px 0;
  background: #333;
  border-radius: 3px;
}
.database-item img {
  margin-right: 10px;
}
#inventoryWarning {
  display: none;
  background: #d32f2f;
  color: white;
  padding: 15px;
  margin: 20px 0;
  border-radius: 8px;
  text-align: center;
}
#inventoryWarning h3 {
  margin: 0 0 10px 0;
}
#beatInfo {
  margin: 10px 0;
  padding: 10px;
  background: #1a1a2e;
  border-radius: 5px;
  display: none;
}
#collaborationStatus {
  position: fixed;
  top: 60px;
  right: 20px;
  background: #2196f3;
  color: white;
  padding: 10px;
  border-radius: 5px;
  display: none;
  z-index: 1000;
}
.beat-marker {
  position: absolute;
  width: 2px;
  height: 100%;
  background: #ff9800;
  opacity: 0.7;
  pointer-events: none;
}
.collaboration-cursor {
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 100;
  transition: all 0.1s;
}

/* Verstecke alle interaktiven Elemente beim Drucken */
@media print {
  button, select, input, textarea, .effect-delete, .effect-edit { display: none !important; }
  #effectList h3, #effectList .effect-item button { display: none !important; }
  .controls, #container > #effectList { display: none !important; }
  #planScreen > h2:not(.print-keep), #planScreen > div:not(#printArea):not(#effectOverview):not(#costCalculation):not(.print-keep) { display: none !important; }
  #planScreen > input, #planScreen > select, #planScreen > button { display: none !important; }
  #planScreen > * { margin: 0 !important; padding: 0 !important; }
  #printArea { display: block !important; }
  #printNotes textarea { border: 1px solid #000 !important; }
  #effectOverview, #costCalculation, #ignitionBox { border: none !important; background: none !important; box-shadow: none !important; }
  h2, h3 { color: #000 !important; }
}

</style>
</head>
<body>
    <div id="planScreen">
        <h2>🔥 FirePlanner 2D - Pro Advanced</h2>
        <div class="controls">
            <h3>Bild/Video als Basis</h3>
            <input type="file" id="backgroundImageUpload" accept="image/*,video/*" onchange="handleBackgroundUpload(event)">
            <button onclick="clearBackground()">Hintergrund entfernen</button>
            <label>
                <input type="checkbox" id="lockCanvasCheckbox" checked> Hintergrund fixieren
            </label>
        </div>

        <div id="container">
            <div id="canvasContainer">
                <canvas id="fireworkCanvas" width="800" height="600"></canvas>
                <div id="warningFlash"></div>
                <img id="backgroundImagePreview" class="image-preview" style="display: none;">
                <video id="backgroundVideoPreview" class="video-preview" style="display: none;" loop muted></video>
                <div id="collaborationStatus" style="display: none;"></div>
            </div>

            <div id="effectList">
                <h3>Effekte Hinzufügen (Drag & Drop auf die Leinwand)</h3>
                <div>
                    <input type="text" id="name" placeholder="Effekt-Name (z.B. Vulkan)">
                    <input type="text" id="time" placeholder="Showzeit (z.B. 0:30)">
                    <select id="type">
                        <option value="single">Single Shot</option>
                        <option value="multi">Multi Shot</option>
                        <option value="ground">Bodeneffekt</option>
                        <option value="special">Spezialeffekt</option>
                    </select>
                    <label>
                        <input type="checkbox" id="hasCost" onchange="toggleCostInput()"> Kostenpflichtig
                    </label>
                    <input type="number" id="cost" placeholder="Kosten (EUR)" min="0" value="0" step="0.01" style="width: 100px; display: none;">
                    <input type="number" id="stock" placeholder="Lagerbestand" min="0" value="1" style="width: 100px;">
                    <label>
                        <input type="checkbox" id="showImage" onchange="toggleImageInput()"> Bild anzeigen
                    </label>
                    <input type="text" id="imageUrl" placeholder="Bild-URL (z.B. Bildlink)" style="display: none;">
                    <label>
                        <input type="checkbox" id="showVideo" onchange="toggleVideoInput()"> Video anzeigen
                    </label>
                    <input type="text" id="videoUrl" placeholder="Video-URL (z.B. YouTube Link)" style="display: none;">
                    <button onclick="addEffect()">✨ Effekt Hinzufügen</button>
                    <button onclick="sortEffects()">↕️ Sortieren</button>
                </div>
                <div id="currentSelection" style="background: #1a1a2e; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <span style="color: #bbb;">✅ Ausgewählter Effekt: Keine</span>
                </div>
                <div id="effectListContent"></div>
                <div id="inventoryWarning">
                    <h3>⚠️ Warnung: Lagerbestand niedrig/aus!</h3>
                    <p id="lowStockItems"></p>
                </div>
                <div class="controls">
                    <button onclick="exportPlan()">💾 Plan Exportieren (JSON)</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importPlan(event)">
                    <button onclick="document.getElementById('importFile').click()">📂 Plan Importieren</button>
                </div>
                <div class="controls" style="background: #1a2e1a; border: 2px solid #2e7d32;">
                    <h3>⏱️ Zeitleisten-Steuerung</h3>
                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <input type="text" id="showDuration" placeholder="Showlänge (Min:Sek)" value="05:00" style="width: 120px;">
                        <button onclick="startShow()">▶️ Start</button>
                        <button onclick="stopShow()">⏸️ Stop</button>
                        <button onclick="resetShow()">⏹️ Reset</button>
                    </div>
                    <div id="timerDisplay">00:00</div>
                    <div id="currentEffect">✨ Nächster Effekt: Warten...</div>
                    <div id="warning" style="display: none;">! VORSICHT !</div>
                </div>
            </div>
        </div>

        <div id="costCalculation">
            <h3>💰 Kostenrechnung</h3>
            <p>Gesamtkosten: <span id="totalCost">0.00 EUR</span></p>
            <p>Anzahl Effekte: <span id="effectCount">0</span></p>
        </div>

        <div id="effectOverview">
            <h3>📝 Effekt-Übersicht (Timeline)</h3>
            <div id="overviewTable">
                <table class="overview-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Name</th>
                            <th>Typ</th>
                            <th>Kosten</th>
                            <th>Lager</th>
                            <th>Zünder</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="timelineDisplay">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="ignitionBox" style="background: #1a1a2e; padding: 15px; border-radius: 8px; border: 2px solid #16213e; margin: 20px 0;">
            <h3>🎙️ Zünder-Zuordnung</h3>
            <p>Wähle einen Effekt, um ihn einem Zündkanal zuzuweisen.</p>
            <div id="currentSelection" style="background: #222; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <span style="color: #bbb;">✅ Ausgewählter Effekt: Keine</span>
            </div>
            <div id="ignitionChannelAssignment">
                <input type="text" id="ignitionBoxInput" placeholder="Zündbox (z.B. 1)" style="width: 100px;">
                <input type="text" id="ignitionChannelInput" placeholder="Kanal (z.B. 01)" style="width: 100px;">
                <button onclick="assignIgnitionChannel()">Zuweisen</button>
                <button onclick="unassignIgnitionChannel()" style="background: #d32f2f;">Entfernen</button>
            </div>
        </div>

        <div class="controls">
            <button onclick="printPlan()">🖶 Plan Drucken (Print View)</button>
            <button onclick="toggleIgnitionOverview()">📝 Zündanlagen-Übersicht anzeigen</button>
            <button onclick="toggleCollaboration()">👥 Kollaboration starten</button>
        </div>

        <div id="qrModal">
            <div class="modal-content">
                <span class="close" onclick="closeQrModal()">&times;</span>
                <h3>🔗 Plan teilen via QR-Code</h3>
                <div id="qrCodeContainer"></div>
                <p>Scanne den Code, um den Plan zu laden.</p>
            </div>
        </div>
        
        <div id="backupStatus">Plan gespeichert!</div>

        <div id="ignitionOverview" style="background: #1a2e1a; padding: 20px; border-radius: 8px; border: 2px solid #2e7d32; margin: 20px 0; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #4caf50; margin: 0;">🎙️ Zündanlagen-Übersicht</h3>
                <button onclick="hideIgnitionOverview()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">❌ Schließen</button>
            </div>
            <div id="ignitionBoxes"></div>
        </div>

        <div id="printArea">
            <h2 class="print-keep" style="text-align: center; color: #000;">🎉 FirePlanner 2D - Feuerwerksplan</h2>
            <div id="printEffects" style="margin-top: 20px;"></div>
            <div id="printIgnition" style="margin-top: 20px;"></div>
            <div id="printCost" style="margin-top: 20px;"></div>
            <div id="printNotes" style="margin-top: 20px;">
                <h3>Notizen:</h3>
                <textarea style="width: 100%; height: 100px; border: 1px solid #000; padding: 5px;"></textarea>
            </div>
        </div>

        <div id="beatInfo">
            <p>BPM: <input type="number" id="bpmInput" value="120" min="1"></p>
            <p>Beat pro Minute: <span id="currentBPM">120</span></p>
            <button onclick="startMetronome()">Metronom Starten</button>
        </div>

        <div id="collaborationStatus"></div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // ===== HAUPT-VARIABLEN =====
        let effects = [];
        const canvas = document.getElementById('fireworkCanvas');
        const ctx = canvas.getContext('2d');
        let selectedEffect = null;
        let isShowRunning = false;
        let showStartTime = 0;
        let showDurationSeconds = 300; // Placeholder
        let showInterval = null;
        let draggedEffect = null;
        let isDraggingBox = false;
        let draggedBox = null;
        let ignitionBoxPositions = {}; // New: Store ignition box positions { 'boxId': {x: 100, y: 100, w: 50, h: 50} }
        let ignitionSystems = {}; // { 'boxId': { channels: { '01': effect, '02': effect } } }
        let isDrawingBox = false; // New state for drawing a new box
        let currentDrawBox = null; // New: { x: 0, y: 0, w: 0, h: 0, id: 'New' }
        let bpm = 120; // Default BPM
        let beatInterval = null; // Metronome interval
        let isMetronomeRunning = false;
        let collaborators = []; // Array for collaboration cursors
        let isCollaborating = false; // Flag for collaboration mode
        let backgroundImage = new Image();
        let backgroundVideo = document.getElementById('backgroundVideoPreview');
        let backgroundVideoLoaded = false;
        let isBackgroundLocked = true; // Initial state
        
        // Neue Funktion zum sicheren Parsen von Integern
        function safeParseInt(value, defaultValue = 0) {
            const parsed = parseInt(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }

        // Neue Funktion zum sicheren Parsen von Floats
        function safeParseFloat(value, defaultValue = 0.00) {
            const parsed = parseFloat(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }

        // Neue Funktion für XSS-Schutz
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Funktion für Managed Event Listener (Memory Management)
        const managedEvents = [];

        function addManagedEventListener(target, type, listener) {
            target.addEventListener(type, listener);
            managedEvents.push({ target, type, listener });
        }

        function removeManagedEventListeners() {
            managedEvents.forEach(({ target, type, listener }) => {
                target.removeEventListener(type, listener);
            });
            managedEvents.length = 0; // Clear the array
        }
        
        // ===== UTILITY PLACEHOLDERS (damit der Code läuft) =====
        function loadPlan() { console.log('Lade Plan...'); }
        function autoSave() { console.log('Auto-Speichern...'); }
        function savePlan() { console.log('Plan gespeichert!'); }
        function updateEffectList() { console.log('Effektliste aktualisiert.'); }
        function calculateTotalCost() { console.log('Kosten berechnet.'); }
        function drawBeatMarkers() { /* Taktlinien zeichnen */ }
        function drawIgnitionBoxes() { /* Zündboxen zeichnen */ }
        function startShow() { console.log('Show gestartet.'); }
        function stopShow() { console.log('Show gestoppt.'); }
        function resetShow() { console.log('Show zurückgesetzt.'); }
        function updateTimer() { console.log('Timer aktualisiert.'); }
        function printPlan() { window.print(); }
        function toggleIgnitionOverview() { console.log('Übersicht umschalten.'); }
        function toggleCollaboration() { console.log('Kollaboration umschalten.'); }
        function closeQrModal() { document.getElementById('qrModal').style.display = 'none'; }
        function showSuccessMessage(message) { console.log(message); }
        function syncWithCollaborators() { console.log('Mit Kollaborateuren synchronisiert.'); }
        function generateNewBoxId() { return 'Box' + (Object.keys(ignitionBoxPositions).length + 1); }
        function handleBackgroundUpload(e) { console.log('Hintergrund hochgeladen.'); }
        function clearBackground() { console.log('Hintergrund entfernt.'); }
        function toggleCostInput() { 
            const costField = document.getElementById('cost');
            const costCheckbox = document.getElementById('hasCost');
            costField.style.display = costCheckbox.checked ? 'inline-block' : 'none';
        }
        function toggleImageInput() {
            const field = document.getElementById('imageUrl');
            const checkbox = document.getElementById('showImage');
            field.style.display = checkbox.checked ? 'inline-block' : 'none';
        }
        function toggleVideoInput() {
            const field = document.getElementById('videoUrl');
            const checkbox = document.getElementById('showVideo');
            field.style.display = checkbox.checked ? 'inline-block' : 'none';
        }
        function sortEffects() { 
            effects.sort((a, b) => a.timeInSeconds - b.timeInSeconds);
            updateEffectList();
            savePlan();
        }
        function assignIgnitionChannel() { console.log('Zündkanal zugewiesen.'); }
        function unassignIgnitionChannel() { console.log('Zündkanal entfernt.'); }
        function updateCurrentSelection() { console.log('Aktuelle Auswahl aktualisiert.'); }
        function selectEffectForIgnition(effectId) {
            selectedEffect = effects.find(e => e && e.id === effectId);
            if (selectedEffect) {
                updateCurrentSelection();
            }
        }
        // =======================================================
        
        // Initialer Lade-Aufruf
        loadPlan();

        // Canvas und Event Listener initialisieren
        initializeCanvasEvents();
        
        // Autorefresh/Backup
        setInterval(autoSave, 5000); // Save every 5 seconds
        
        // ===== HAUPT-FUNKTIONEN =====

        function drawCanvas() {
            try {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 1. Hintergrund zeichnen (Video/Bild)
                drawBackground();

                // 2. Taktlinien (Beats) zeichnen (optional)
                drawBeatMarkers();

                // 3. Zündboxen zeichnen
                drawIgnitionBoxes();

                // 4. Effekte zeichnen
                effects.forEach(effect => {
                    if (!effect) return; // Sicherheit

                    const isCurrentEffect = isShowRunning && effect.timeInSeconds <= (Date.now() - showStartTime) / 1000 && (effect.timeInSeconds + 1) > (Date.now() - showStartTime) / 1000;
                    
                    // a) Draw Effect Point
                    ctx.beginPath();
                    ctx.arc(effect.x, effect.y, 8, 0, 2 * Math.PI);
                    ctx.fillStyle = isCurrentEffect ? '#ff0000' : (selectedEffect && selectedEffect.id === effect.id) ? '#4caf50' : '#00bfff';
                    ctx.shadowColor = isCurrentEffect ? 'red' : 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = isCurrentEffect ? 15 : 0;
                    ctx.fill();
                    
                    // b) Draw Icon/Image/Video markers
                    if (effect.image) {
                        ctx.fillStyle = '#ff00ff';
                        ctx.font = '16px Arial';
                        ctx.fillText('📸', effect.x - 8, effect.y - 12);
                    }
                    
                    if (effect.video) {
                        ctx.fillStyle = '#ff00ff';
                        ctx.font = '16px Arial';
                        ctx.fillText('🎬', effect.x + 8, effect.y - 12);
                    }
                    
                    // c) Draw Name/Time
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${escapeHtml(effect.name)} (${formatTime(effect.timeInSeconds)})`, effect.x, effect.y - 15);
                    
                    // d) Draw Channel/Box info
                    if (effect.ignitionBox && effect.ignitionChannel) {
                        ctx.fillStyle = '#ffcc00';
                        ctx.font = '10px Arial';
                        ctx.fillText(`Box ${escapeHtml(effect.ignitionBox)}-${escapeHtml(effect.ignitionChannel)}`, effect.x, effect.y + 18);
                    }
                });
                
                // 5. Drawing a new box in progress
                if (isDrawingBox && currentDrawBox) {
                    ctx.strokeStyle = '#4caf50';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(currentDrawBox.x, currentDrawBox.y, currentDrawBox.w, currentDrawBox.h);
                    ctx.fillStyle = 'rgba(76, 175, 80, 0.2)';
                    ctx.fillRect(currentDrawBox.x, currentDrawBox.y, currentDrawBox.w, currentDrawBox.h);
                }

                // 6. Collaboration Cursors
                drawCollaborationCursors();
                
                ctx.textAlign = 'left'; // Reset text alignment
            } catch (error) {
                console.error('❌ Fehler beim Zeichnen des Canvas:', error);
            }
        }

        // Funktion zum Zeichnen des Hintergrunds
        function drawBackground() {
            ctx.globalAlpha = 0.5; // Make background transparent
            
            if (backgroundVideo.style.display !== 'none' && backgroundVideoLoaded) {
                ctx.drawImage(backgroundVideo, 0, 0, canvas.width, canvas.height);
            } else if (backgroundImage.src && backgroundImage.complete && backgroundImage.naturalWidth !== 0) {
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            }
            
            ctx.globalAlpha = 1.0; // Reset opacity
        }

        // ... (rest of the functions are just placeholders, starting with safeParseInt/Float) ...
        
        // ===== SICHERE ZEIT-FUNKTIONEN =====
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            try {
                const parts = timeStr.toString().split(':');
                if (parts.length === 2) {
                    const minutes = safeParseInt(parts[0]);
                    const seconds = safeParseInt(parts[1]);
                    return minutes * 60 + seconds;
                }
                // Fallback für reine Sekunden
                return safeParseInt(timeStr);
            } catch (error) {
                console.warn('⚠️ Fehler beim Parsen der Zeit:', timeStr, error);
                return 0;
            }
        }

        function formatTime(seconds) {
            try {
                const safeSeconds = safeParseInt(seconds);
                const mins = Math.floor(safeSeconds / 60);
                const secs = safeSeconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } catch (error) {
                console.warn('⚠️ Fehler beim Formatieren der Zeit:', seconds, error);
                return '00:00';
            }
        }

        // ===== SICHERE EFFEKT-HINZUFÜGUNG =====
        function addEffect() {
            console.log('🚀 SICHERE addEffect() Version 5.0 - ULTRA-SICHER');
            
            try {
                // SOFORTIGE ELEMENT-PRÜFUNG
                const nameField = document.getElementById('name');
                const timeField = document.getElementById('time');
                const typeField = document.getElementById('type');
                const costCheckbox = document.getElementById('hasCost');
                const costField = document.getElementById('cost');
                const stockField = document.getElementById('stock');
                const imageCheckbox = document.getElementById('showImage');
                const imageUrlField = document.getElementById('imageUrl');
                const videoCheckbox = document.getElementById('showVideo');
                const videoUrlField = document.getElementById('videoUrl');

                if (!nameField || !timeField) {
                    console.error('❌ KRITISCH: Eingabefelder nicht gefunden!');
                    alert('❌ KRITISCHER FEHLER: Eingabefelder nicht gefunden!\n\nBitte lade die Seite neu (F5)!');
                    return false;
                }
                
                // WERTE ERFASSEN mit Fallback
                const name = (nameField.value || '').trim();
                const time = (timeField.value || '').trim();
                const timeInSeconds = parseTime(time);
                const type = typeField.value || 'single';
                const hasCost = costCheckbox.checked;
                const cost = safeParseFloat(costField.value);
                const stock = safeParseInt(stockField.value, 1);
                const showImage = imageCheckbox.checked;
                const imageUrl = (imageUrlField.value || '').trim();
                const showVideo = videoCheckbox.checked;
                const videoUrl = (videoUrlField.value || '').trim();
                
                console.log('📝 EINGABE-CHECK:', { name: `"${name}"`, time: `"${time}"`, timeInSeconds, type, cost, stock });
                
                // SOFORTIGE VALIDIERUNG
                if (!name) {
                    console.log('⚠️ Kein Name eingegeben');
                    alert('❌ Bitte einen Effektnamen eingeben!');
                    nameField.focus();
                    nameField.style.borderColor = '#ff0000';
                    nameField.style.boxShadow = '0 0 10px rgba(255,0,0,0.5)';
                    setTimeout(() => {
                        nameField.style.borderColor = '#555'; // FEHLER KORRIGIERT: Entfernte das doppelte .style
                        nameField.style.boxShadow = 'none';
                    }, 3000);
                    return false;
                }
                
                if (timeInSeconds <= 0) {
                    console.log('⚠️ Ungültige oder keine Zeit eingegeben');
                    alert('❌ Bitte eine gültige Showzeit eingeben (z.B. 1:30)!');
                    timeField.focus();
                    timeField.style.borderColor = '#ff0000';
                    timeField.style.boxShadow = '0 0 10px rgba(255,0,0,0.5)';
                    setTimeout(() => {
                        timeField.style.borderColor = '#555';
                        timeField.style.boxShadow = 'none';
                    }, 3000);
                    return false;
                }
                
                // EFFEKT ERSTELLEN
                const newEffect = {
                    id: Date.now() + Math.random(), // Eindeutige ID
                    name: name,
                    time: time, // Original string for display
                    timeInSeconds: timeInSeconds,
                    type: type,
                    hasCost: hasCost,
                    cost: cost,
                    stock: stock,
                    image: showImage ? imageUrl : null,
                    video: showVideo ? videoUrl : null,
                    x: Math.floor(Math.random() * 800), // Startposition auf der Leinwand
                    y: Math.floor(Math.random() * 600),
                    ignitionBox: null, // Zündbox-Zuordnung
                    ignitionChannel: null // Zündkanal-Zuordnung
                };

                effects.push(newEffect);
                
                // AUFRÄUMEN & AKTUALISIEREN
                nameField.value = '';
                timeField.value = '';
                costField.value = '0';
                stockField.value = '1';
                imageUrlField.value = '';
                videoUrlField.value = '';
                costCheckbox.checked = false;
                imageCheckbox.checked = false;
                videoCheckbox.checked = false;
                toggleCostInput(); // Reset visibility
                
                sortEffects(); // Sortiert sofort nach Zeit
                updateEffectList();
                calculateTotalCost();
                drawCanvas();
                savePlan();
                
                showSuccessMessage(`✅ Effekt "${newEffect.name}" zu ${newEffect.time} hinzugefügt!`);
                
                return true;
            } catch (error) {
                console.error('❌ KRITISCHER FEHLER in addEffect():', error);
                alert(`❌ Kritischer Fehler beim Hinzufügen des Effekts: ${error.message}`);
                return false;
            }
        }
        
        // ===== CANVAS EVENTS (KORRIGIERT) =====
        function initializeCanvasEvents() {
            // Mouse events for moving IGNITION BOXES or drawing a new box
            let startDragX = 0;
            let startDragY = 0;
            let currentBoxX = 0;
            let currentBoxY = 0;

            const mouseDownHandler = function(e) {
                try {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // 1. Check for Box Drag Start
                    for (const boxId in ignitionBoxPositions) {
                        const pos = ignitionBoxPositions[boxId];
                        if (x >= pos.x && x <= pos.x + pos.w && y >= pos.y && y <= pos.y + pos.h) {
                            isDraggingBox = true;
                            draggedBox = boxId;
                            startDragX = x;
                            startDragY = y;
                            currentBoxX = pos.x;
                            currentBoxY = pos.y;
                            canvas.style.cursor = 'move';
                            return; // Start dragging box, no other action
                        }
                    }

                    // 2. Start Drawing a new box (if no box clicked)
                    isDrawingBox = true;
                    currentDrawBox = { x: x, y: y, w: 0, h: 0, id: 'New' };
                    canvas.style.cursor = 'crosshair';
                } catch (error) {
                    console.error('❌ Fehler bei Mouse-Down:', error);
                }
            };

            const mouseMoveBoxHandler = function(e) {
                try {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (isDraggingBox && draggedBox) {
                        // Dragging existing box
                        const dx = x - startDragX;
                        const dy = y - startDragY;
                        
                        // Update position in the map
                        ignitionBoxPositions[draggedBox].x = currentBoxX + dx;
                        ignitionBoxPositions[draggedBox].y = currentBoxY + dy;
                        
                        drawCanvas(); // Redraw constantly
                    } else if (isDrawingBox && currentDrawBox) {
                        // Drawing a new box
                        currentDrawBox.w = x - currentDrawBox.x;
                        currentDrawBox.h = y - currentDrawBox.y;
                        drawCanvas(); // Redraw constantly
                    }
                } catch (error) {
                    // console.error('❌ Fehler bei Mouse-Move:', error); // Too noisy
                }
            };

            const mouseUpHandler = function(e) {
                try {
                    // 1. End dragging existing box
                    if (isDraggingBox && draggedBox) {
                        isDraggingBox = false;
                        canvas.style.cursor = 'crosshair';
                        
                        // Speichere die finalen Box-Positionen (wurde von mouseMoveBoxHandler geupdated)
                        try {
                            // savePlan() wird aufgerufen
                            savePlan();
                        } catch (saveError) {
                            console.warn('⚠️ Konnte Box-Positionen nicht speichern:', saveError);
                        }
                        
                        // Sync with collaborators
                        if (isCollaborating) {
                            syncWithCollaborators();
                        }
                        
                        showSuccessMessage(`✅ Box ${draggedBox} verschoben!`);
                        draggedBox = null;
                    }
                    
                    // 2. End Drawing a new box
                    if (isDrawingBox && currentDrawBox) {
                        isDrawingBox = false;
                        canvas.style.cursor = 'crosshair';
                        
                        // Check if the drawn area is large enough
                        if (Math.abs(currentDrawBox.w) > 50 && Math.abs(currentDrawBox.h) > 50) {
                            const newBoxId = generateNewBoxId();
                            
                            // Normalize dimensions (x, y should be top-left)
                            const finalX = Math.min(currentDrawBox.x, currentDrawBox.x + currentDrawBox.w);
                            const finalY = Math.min(currentDrawBox.y, currentDrawBox.y + currentDrawBox.h);
                            const finalW = Math.abs(currentDrawBox.w);
                            const finalH = Math.abs(currentDrawBox.h);

                            ignitionBoxPositions[newBoxId] = {
                                x: finalX,
                                y: finalY,
                                w: finalW,
                                h: finalH
                            };
                            ignitionSystems[newBoxId] = { channels: {} };

                            showSuccessMessage(`✅ Neue Zündbox ${newBoxId} erstellt!`);
                            savePlan();
                        } else {
                            showSuccessMessage(`⚠️ Box war zu klein. Zeichnen abgebrochen.`);
                        }
                        currentDrawBox = null;
                        drawCanvas(); // Redraw without drawing box in progress
                    }
                } catch (error) {
                    console.error('❌ Fehler bei Mouse-Up:', error);
                }
            };
            
            addManagedEventListener(canvas, 'mousedown', mouseDownHandler);
            addManagedEventListener(canvas, 'mousemove', mouseMoveBoxHandler);
            addManagedEventListener(canvas, 'mouseup', mouseUpHandler);
            
            // Drag and drop for canvas (Effects)
            const dragOverHandler = function(e) {
                e.preventDefault();
            };
            
            const dropHandler = function(e) {
                e.preventDefault();
                if (draggedEffect) {
                    try {
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        draggedEffect.x = x;
                        draggedEffect.y = y;
                        updateEffectList();
                        drawCanvas();
                        savePlan();
                        
                        // Sync with collaborators
                        if (isCollaborating) {
                            syncWithCollaborators();
                        }
                        
                        draggedEffect = null;
                    } catch (error) {
                        console.error('❌ Fehler beim Drop:', error);
                    }
                }
            };
            
            addManagedEventListener(canvas, 'dragover', dragOverHandler);
            addManagedEventListener(canvas, 'drop', dropHandler);
        }

        function drawCollaborationCursors() {
            try {
                // In a real implementation, this would draw other users' cursors
                // For now, we'll just show a placeholder
                if (Array.isArray(collaborators) && collaborators.length > 0) {
                    collaborators.forEach((collaborator, index) => {
                        if (!collaborator || typeof collaborator.x !== 'number' || typeof collaborator.y !== 'number') return;
                        
                        ctx.fillStyle = `hsl(${index * 60}, 70%, 50%)`;
                        ctx.beginPath();
                        ctx.arc(collaborator.x, collaborator.y, 5, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '10px Arial';
                        ctx.fillText(escapeHtml(collaborator.name || 'User'), collaborator.x + 10, collaborator.y - 10);
                    });
                }
            } catch (error) {
                console.error('❌ Fehler beim Zeichnen der Kollaborations-Cursor:', error);
            }
        }
        
        console.log('✅ FirePlanner 2D Pro Advanced - Korrigierte Version geladen!');
    </script>
</body>
</html>
