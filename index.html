<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>ğŸ† FirePlanner 2D - Pro Advanced (Korrigiert)</title>
<style>
body {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
  margin: 0;
  background: #111;
  color: #eee;
}
h1, h2 {
  text-align: center;
  margin: 10px 0;
}
input, button, select, textarea {
  margin: 5px;
  padding: 8px;
  background: #222;
  color: #fff;
  border: 1px solid #555;
  border-radius: 5px;
  font-size: 14px;
  outline: none;
}


input:focus, textarea:focus, select:focus {
  background: #333;
  border-color: #4caf50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
}


input[type="text"], input[type="number"], textarea {
  width: 200px;
  max-width: 100%;
}
button {
  cursor: pointer;
  background: #444;
  transition: 0.2s;
  padding: 10px 15px;
}
button:hover {
  background: #666;
}
#container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
}
#effectList {
  max-width: 400px;
  margin: 10px;
}
.effect-item {
  border: 1px solid #555;
  padding: 10px;
  margin: 8px 0;
  border-radius: 5px;
  background: #222;
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
}
.effect-item:hover {
  background: #333;
  transform: translateY(-2px);
}
.effect-item.dragging {
  opacity: 0.5;
  transform: rotate(5deg);
}
.effect-item.low-stock {
  border-color: #ff9800;
  background: #2d1b0f;
}
.effect-item.out-of-stock {
  border-color: #f44336;
  background: #2d0f0f;
}
#canvasContainer {
  position: relative;
  margin: 10px auto;
  border: 2px solid #555;
  background: #000;
  border-radius: 8px;
}
#fireworkCanvas {
  cursor: crosshair;
  display: block;
  border-radius: 6px;
}
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background: #333;
  color: #fff;
  text-align: left;
  border-radius: 5px;
  padding: 8px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
#timerDisplay {
  font-size: 3em;
  text-align: center;
  margin: 20px 0;
  font-weight: bold;
  color: #0ff;
}
#currentEffect {
  font-size: 1.4em;
  color: #ff0;
  text-align: center;
  margin: 15px 0;
  padding: 10px;
  background: #222;
  border-radius: 5px;
  min-height: 60px;
}
#warning {
  font-size: 2.5em;
  color: #f00;
  text-align: center;
  margin: 15px 0;
  font-weight: bold;
}
#timelineDisplay {
  text-align: center;
  margin: 15px 0;
  padding: 10px;
  background: #222;
  border-radius: 5px;
}
#printArea {
  display: none;
}
#warningFlash {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: red;
  opacity: 0;
  pointer-events: none;
  border-radius: 5px;
  transition: opacity 0.1s;
}
.controls {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #222;
  border-radius: 8px;
}
.effect-delete {
  background: #d32f2f;
  color: white;
  border: none;
  padding: 5px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}
.effect-delete:hover {
  background: #b71c1c;
}
#costCalculation {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #1a4d1a;
  border-radius: 8px;
  border: 2px solid #2e7d32;
}
#costCalculation h3 {
  margin: 0 0 10px 0;
  color: #4caf50;
}
#totalCost {
  font-size: 1.5em;
  font-weight: bold;
  color: #81c784;
}
#effectCount {
  color: #a5d6a7;
  margin-top: 5px;
}
.explosion {
  position: absolute;
  pointer-events: none;
  border-radius: 50%;
  animation: explode 1s ease-out forwards;
}
@keyframes explode {
  0% { transform: scale(0); opacity: 1; }
  50% { transform: scale(1.5); opacity: 0.8; }
  100% { transform: scale(3); opacity: 0; }
}
#qrModal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
}
.modal-content {
  background-color: #222;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #555;
  border-radius: 10px;
  width: 300px;
  text-align: center;
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover {
  color: #fff;
}
#backupStatus {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 10px;
  border-radius: 5px;
  display: none;
  z-index: 1000;
}
#effectOverview {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: #1a1a2e;
  border-radius: 8px;
  border: 2px solid #16213e;
}
#effectOverview h3 {
  margin: 0 0 15px 0;
  color: #0f3460;
}
#overviewTable {
  overflow-x: auto;
}
.overview-table {
  width: 100%;
  border-collapse: collapse;
  background: #222;
  border-radius: 5px;
  overflow: hidden;
}
.overview-table th {
  background: #333;
  color: #fff;
  padding: 10px 8px;
  text-align: left;
  font-size: 12px;
  border-bottom: 2px solid #555;
}
.overview-table td {
  padding: 8px;
  border-bottom: 1px solid #444;
  font-size: 11px;
  color: #ddd;
}
.overview-table tr:hover {
  background: #2a2a2a;
}
.time-cell {
  color: #4caf50;
  font-weight: bold;
}
.channel-cell {
  color: #2196f3;
  font-weight: bold;
}
.button-cell {
  color: #ff9800;
  font-weight: bold;
}
.database-info {
  background: #2a2a2a;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  font-size: 12px;
  color: #ccc;
}
.image-preview {
  max-width: 200px;
  max-height: 150px;
  border-radius: 5px;
  border: 2px solid #555;
  margin: 10px 0;
}
.video-preview {
  max-width: 200px;
  max-height: 150px;
  border-radius: 5px;
  border: 2px solid #555;
  margin: 10px 0;
}
.effect-image {
  max-width: 50px;
  max-height: 50px;
  border-radius: 3px;
  margin-right: 10px;
  vertical-align: middle;
}
.effect-video {
  max-width: 50px;
  max-height: 50px;
  border-radius: 3px;
  margin-right: 10px;
  vertical-align: middle;
}
.database-item {
  display: flex;
  align-items: center;
  padding: 5px;
  margin: 2px 0;
  background: #333;
  border-radius: 3px;
}
.database-item img {
  margin-right: 10px;
}
#inventoryWarning {
  display: none;
  background: #d32f2f;
  color: white;
  padding: 15px;
  margin: 20px 0;
  border-radius: 8px;
  text-align: center;
}
#inventoryWarning h3 {
  margin: 0 0 10px 0;
}
#beatInfo {
  margin: 10px 0;
  padding: 10px;
  background: #1a1a2e;
  border-radius: 5px;
  display: none;
}
#collaborationStatus {
  position: fixed;
  top: 60px;
  right: 20px;
  background: #2196f3;
  color: white;
  padding: 10px;
  border-radius: 5px;
  display: none;
  z-index: 1000;
}
.beat-marker {
  position: absolute;
  width: 2px;
  height: 100%;
  background: #ff9800;
  opacity: 0.7;
  pointer-events: none;
}
.collaboration-cursor {
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 100;
  transition: all 0.1s;
}


/* Verstecke alle interaktiven Elemente beim Drucken */
@media print {
  button, select, input, textarea, .effect-delete, .effect-edit { display: none !important; }
  #effectList h3, #effectList .effect-item button { display: none !important; }
  .controls, #container > #effectList { display: none !important; }
  #planScreen > h2:not(.print-keep), #planScreen > div:not(#printArea):not(#effectOverview):not(#costCalculation):not(.print-keep) { display: none !important; }
  #planScreen > input, #planScreen > select, #planScreen > button { display: none !important; }
  #planScreen > br { display: none !important; }
  .database-info { display: none !important; }
  
  /* Verstecke spezifische Bearbeitungsbereiche */
  #planScreen > div[style*="display: grid"], 
  #planScreen > div[style*="display: flex"],
  #planScreen > div[style*="margin: 10px 0"]:not(#effectOverview):not(#costCalculation):not(#inventoryWarning) { display: none !important; }
  
  /* Verstecke alle Formularbereiche */
  #planScreen > div:has(input), 
  #planScreen > div:has(select), 
  #planScreen > div:has(button),
  #planScreen > div:has(textarea) { display: none !important; }
  
  /* Verstecke Dropdown-MenÃ¼s und Eingabefelder */
  .effect-item select, .effect-item input, .effect-item button { display: none !important; }
  
  /* Verstecke Bearbeitungshinweise */
  .database-info, .beat-info, #beatInfo { display: none !important; }
  
  /* Verstecke Kollaborations-Status */
  #collaborationStatus, #backupStatus { display: none !important; }
  
  /* Zeige nur relevante Bereiche */
  #printArea { display: block !important; }
  #effectOverview { display: block !important; }
  #costCalculation { display: block !important; }
  
  /* Verbessere Tabellen-Layout */
  .overview-table th { background-color: #f0f0f0 !important; color: #000 !important; }
  .overview-table td { color: #000 !important; }
  
  /* SeitenumbrÃ¼che optimieren */
  .summary { page-break-inside: avoid; }
  .inventory-warning { page-break-inside: avoid; }
  table { page-break-inside: auto; }
  tr { page-break-inside: avoid; page-break-after: auto; }
  
  /* Verstecke Scrollbalken */
  * { overflow: visible !important; }
}
</style>
</head>
<body>


<h1>ğŸ† FirePlanner 2D - Pro Advanced (Korrigiert)</h1>


<div id="planScreen">
<h2>Show-Name</h2>
<input id="showName" placeholder="Name der Show">


<h2>Effekt hinzufÃ¼gen</h2>
<select id="effectSavedList" onchange="selectSavedEffect()">
  <option value="">Vorherige Effekte</option>
</select>
<div style="position: relative; display: inline-block;">
  <select id="effectDatabase" onchange="selectFromDatabase()">
    <option value="">Effekt-Datenbank</option>
  </select>
  <input type="text" id="effectSearch" placeholder="ğŸ” Effekt suchen..." 
         style="display: none; position: absolute; top: 0; left: 0; width: 100%; z-index: 10;"
         onkeyup="searchEffects()" onblur="hideSearch()">
</div>
<button onclick="showSearch()" id="searchButton" style="display: none;">ğŸ” Suchen</button><br>


<div class="database-info">
  ğŸ“Š <strong>Excel-Import Format:</strong> Name | Barcode | Dauer | Preis | Typ | Lagerbestand<br>
  Beispiel: "Goldener Regen | 4260123456789 | 0:15 | 12.50 | rocket | 25"<br>
  ğŸ“¸ <strong>Bilder & Videos:</strong> Optional - kÃ¶nnen einzeln hochgeladen werden
</div>


<h3>ğŸ“¸ Bild fÃ¼r Effekt (Optional)</h3>
<input type="file" id="effectImage" accept="image/*" onchange="previewImage()">
<div id="imagePreview" style="margin: 10px 0;"></div>
<button onclick="clearImage()">ğŸ—‘ï¸ Bild entfernen</button>


<h3>ğŸ¬ Video-Vorschau (Optional)</h3>
<input type="file" id="effectVideo" accept="video/*" onchange="previewVideo()">
<div id="videoPreview" style="margin: 10px 0;"></div>
<button onclick="clearVideo()">ğŸ—‘ï¸ Video entfernen</button>


<input id="name" placeholder="Effektname">
<select id="effectType">
  <option value="rocket">Rakete</option>
  <option value="fountain">FontÃ¤ne</option>
  <option value="battery">Batterie</option>
</select>
<input id="plannedDuration" placeholder="Dauer (m:s)">
<input id="price" placeholder="Preis (â‚¬)" type="number" step="0.01">
<input id="barcode" placeholder="Barcode/EAN">
<input id="time" placeholder="Showzeit (m:s)">
<input id="channel" placeholder="Kanal" type="number" min="1">
<input id="receiver" placeholder="EmpfÃ¤nger">
<input id="buttonKey" placeholder="Taste">
<input id="quantity" placeholder="Anzahl Effekte">
<input id="stockQuantity" placeholder="Lagerbestand" type="number">
<textarea id="additionalInfo" placeholder="Zusatzinfos"></textarea>
<button onclick="addEffect()">Effekt speichern</button>
<button onclick="addToDatabase()">Zur Datenbank hinzufÃ¼gen</button>
<input type="file" id="excelImport" accept=".csv,.txt,.tsv" onchange="importExcelDatabase()">
<button onclick="document.getElementById('excelImport').click()">ğŸ“Š Excel-Datenbank importieren</button>
<button onclick="clearDatabase()">ğŸ—‘ï¸ Datenbank leeren</button>


<div id="container">
  <div id="canvasContainer">
    <canvas id="fireworkCanvas" width="800" height="500"></canvas>
    <div id="warningFlash"></div>
  </div>
  <div id="effectList"></div>
</div>


<div id="costCalculation">
  <h3>ğŸ’° Kostenkalkulation</h3>
  <div id="totalCost">Gesamtkosten: 0,00 â‚¬</div>
  <div id="effectCount">Anzahl Effekte: 0</div>
</div>


<div id="inventoryWarning">
  <h3>âš ï¸ Lagerbestand-Warnung</h3>
  <div id="lowStockItems"></div>
</div>


<div id="effectOverview">
  <h3>ğŸ“‹ Effekt-Ãœbersicht</h3>
  <div id="overviewTable"></div>
</div>


<h2>ğŸµ Musik & Beat-Sync</h2>
<input type="file" id="musicFile" accept="audio/*" onchange="loadMusic()">
<button onclick="analyzeBeat()" id="beatAnalyzeBtn" style="display: none;">ğŸµ Beat analysieren</button>
<button onclick="autoSyncEffects()" id="autoSyncBtn" style="display: none;">âš¡ Auto-Sync zu Beats</button>
<div id="beatInfo">
  <strong>ğŸµ Beat-Analyse:</strong><br>
  <span id="bpmDisplay">BPM: Nicht analysiert</span><br>
  <span id="beatCount">Beats gefunden: 0</span>
</div>


<h2>ğŸ“¡ ZÃ¼ndanlagen-Verwaltung</h2>
<div style="background: #1a1a2e; padding: 20px; border-radius: 8px; border: 2px solid #16213e; margin: 20px 0;">
  <h3 style="color: #4caf50; margin: 0 0 15px 0;">ğŸ¯ Effekt zu ZÃ¼ndbox zuweisen</h3>
  
  <div id="currentSelection" style="background: #222; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #4caf50;">
    <p style="color: #666; font-style: italic;">Kein Effekt ausgewÃ¤hlt</p>
  </div>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
    <div>
      <label style="color: #ccc; display: block; margin: 0 0 5px;">ğŸ“¡ ZÃ¼ndbox auswÃ¤hlen:</label>
      <select id="ignitionBox" onchange="selectIgnitionBox()" style="width: 100%; padding: 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 5px;">
        <option value="">Box wÃ¤hlen</option>
        <option value="A">Box A (32 KanÃ¤le)</option>
        <option value="B">Box B (32 KanÃ¤le)</option>
        <option value="C">Box C (32 KanÃ¤le)</option>
        <option value="D">Box D (32 KanÃ¤le)</option>
        <option value="E">Box E (32 KanÃ¤le)</option>
        <option value="F">Box F (32 KanÃ¤le)</option>
      </select>
    </div>
    
    <div>
      <label style="color: #ccc; display: block; margin: 0 0 5px;">ğŸ”¢ Kanal (1-32):</label>
      <input id="selectedChannel" type="number" min="1" max="32" placeholder="Kanal eingeben" style="width: 100%; padding: 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 5px;">
    </div>
  </div>
  
  <div style="text-align: center; margin: 20px 0;">
    <button onclick="assignToBox()" style="background: #4caf50; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
      ğŸ† Effekt zu Box zuweisen
    </button>
  </div>
  
  <div style="margin: 20px 0;">
    <h4 style="color: #ff9800; margin: 0 0 10px 0;">âš¡ Schnell-Zuweisung:</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
      <button onclick="quickAssign('A', 1)" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">A1</button>
      <button onclick="quickAssign('A', 2)" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">A2</button>
      <button onclick="quickAssign('B', 1)" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">B1</button>
      <button onclick="quickAssign('B', 2)" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">B2</button>
      <button onclick="quickAssign('C', 1)" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">C1</button>
      <button onclick="quickAssign('C', 2)" style="background: #2196f3; color: white; border: none; padding: 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">C2</button>
    </div>
  </div>
  
  <div style="text-align: center; margin: 20px 0;">
    <button onclick="showIgnitionOverview()" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px;">
      ğŸ“‹ ZÃ¼ndanlagen-Ãœbersicht anzeigen
    </button>
    <button onclick="resetBoxPositions()" style="background: #9c27b0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px;">
      ğŸ”„ Box-Positionen zurÃ¼cksetzen
    </button>
  </div>
</div>


<div id="ignitionOverview" style="background: #1a2e1a; padding: 20px; border-radius: 8px; border: 2px solid #2e7d32; margin: 20px 0; display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="color: #4caf50; margin: 0;">ğŸ“¡ ZÃ¼ndanlagen-Ãœbersicht</h3>
    <button onclick="hideIgnitionOverview()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">âœ• SchlieÃŸen</button>
  </div>
  <div id="ignitionBoxes"></div>
</div>


<h2>ğŸŒ¡ï¸ Wetter-Monitor</h2>
<div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0;">
  <input id="windSpeed" placeholder="Windgeschwindigkeit (km/h)" type="number">
  <select id="windDirection">
    <option value="">Windrichtung</option>
    <option value="N">Nord</option>
    <option value="NO">Nordost</option>
    <option value="O">Ost</option>
    <option value="SO">SÃ¼dost</option>
    <option value="S">SÃ¼d</option>
    <option value="SW">SÃ¼dwest</option>
    <option value="W">West</option>
    <option value="NW">Nordwest</option>
  </select>
  <input id="temperature" placeholder="Temperatur (Â°C)" type="number">
  <input id="humidity" placeholder="Luftfeuchtigkeit (%)" type="number">
  <button onclick="checkWeatherConditions()">ğŸŒ¤ï¸ Wetter prÃ¼fen</button>
</div>
<div id="weatherStatus" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;"></div>


<div class="controls">
<button onclick="saveShow()">Show speichern</button>
<button onclick="loadSavedShows()">Show laden</button>
<select id="savedShows" onchange="selectShow()">
  <option value="">Gespeicherte Shows</option>
</select>
<button onclick="exportShow()">Export JSON</button>
<input type="file" id="importFile" accept=".json" onchange="importShow()">
<button onclick="importShow()">Import JSON</button>
<button onclick="printPlan()">Druckversion</button>
<button onclick="generateQRCode()">ğŸ“± Smartphone-Steuerung</button>
<button onclick="loadFromSession()">ğŸ”— Session laden</button>
<button onclick="startCollaboration()">ğŸ‘¥ Team-Kollaboration</button>
<button onclick="joinCollaboration()">ğŸ¤ Team beitreten</button>
<button onclick="autoBackup()">ğŸ’¾ Auto-Backup</button>
<button onclick="startShow()">Show starten</button>
<button onclick="pauseShow()">Pause</button>
<button onclick="resumeShow()">Fortsetzen</button>
<button onclick="stopShow()">Stopp</button>
</div>
</div>


<div id="showScreen" style="display:none;">
<h2>Show Timer</h2>
<div id="timerDisplay">00:00</div>
<div id="warning"></div>
<div id="currentEffect"></div>
<div id="timelineDisplay"></div>
<button onclick="backToPlan()" style="margin: 20px;">ZurÃ¼ck zur Planung</button>
</div>


<div class="print-area" id="printArea"></div>


<!-- QR Code Modal -->
<div id="qrModal">
  <div class="modal-content">
    <span class="close" onclick="closeQRModal()">&times;</span>
    <h3>ğŸ“± Smartphone-Steuerung</h3>
    <div id="qrCode"></div>
    <p>Scanne den QR-Code mit deinem Smartphone</p>
    <div id="remoteUrl"></div>
  </div>
</div>


<div id="backupStatus">Backup erstellt!</div>
<div id="collaborationStatus">Team-Modus aktiv</div>


<audio id="warningBeep" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
</audio>
<audio id="fireBeep" preload="auto">
  <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
</audio>
<audio id="musicPlayer"></audio>


<script>
// ===== KORRIGIERTE VERSION - ALLE FEHLER BEHOBEN =====


let effects = [];
let showTimer = null;
let showStartTime = 0;
let isPaused = false;
let pausedTime = 0;
let canvas, ctx;
let savedEffects = [];
let effectDatabase = [];
let draggedEffect = null;
let autoBackupInterval = null;
let currentEffectImage = null;
let currentEffectVideo = null;


// ZÃ¼ndanlagen-Variablen
let selectedEffect = null;
let ignitionBoxes = {
  A: {},
  B: {},
  C: {},
  D: {},
  E: {},
  F: {}
};


// ZÃ¼ndbox-Positionen (verschiebbar)
let ignitionBoxPositions = {
  A: { x: 50, y: 50 },
  B: { x: 150, y: 50 },
  C: { x: 250, y: 50 },
  D: { x: 50, y: 120 },
  E: { x: 150, y: 120 },
  F: { x: 250, y: 120 }
};


// Drag & Drop fÃ¼r ZÃ¼ndboxen
let draggedBox = null;
let dragOffset = { x: 0, y: 0 };
let isDraggingBox = false;


// Beat-Sync Variables
let audioContext = null;
let audioBuffer = null;
let beatTimes = [];
let bpm = 0;


// Collaboration Variables
let collaborationId = null;
let isCollaborating = false;
let collaborators = [];
let lastSyncTime = 0;


// Inventory Variables
let inventoryWarnings = [];


// Cleanup Variables
let intervals = [];
let eventListeners = [];


# ===== UTILITY FUNCTIONS (SICHERHEIT) =====
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text.toString();
  return div.innerHTML;
}


function generateUniqueId() {
  return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${Math.floor(Math.random() * 10000)}`;
}


function safeParseInt(value, defaultValue = 0) {
  const parsed = parseInt(value);
  return isNaN(parsed) ? defaultValue : parsed;
}


function safeParseFloat(value, defaultValue = 0) {
  const parsed = parseFloat(value);
  return isNaN(parsed) ? defaultValue : parsed;
}


function addManagedInterval(callback, delay) {
  const id = setInterval(callback, delay);
  intervals.push(id);
  return id;
}


function addManagedEventListener(element, event, callback) {
  if (!element) return;
  element.addEventListener(event, callback);
  eventListeners.push({ element, event, callback });
}


function cleanup() {
  intervals.forEach(id => {
    try {
      clearInterval(id);
    } catch (e) {
      console.warn('Error clearing interval:', e);
    }
  });
  intervals = [];
  
  eventListeners.forEach(({ element, event, callback }) => {
    try {
      if (element && element.removeEventListener) {
        element.removeEventListener(event, callback);
      }
    } catch (e) {
      console.warn('Error removing event listener:', e);
    }
  });
  eventListeners = [];
}


function showSuccessMessage(message, duration = 3000) {
  const successMsg = document.createElement('div');
  successMsg.style.cssText = `
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(45deg, #4caf50, #66bb6a);
    color: white; padding: 15px 25px; border-radius: 8px;
    z-index: 10000; font-weight: bold; font-size: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    border: 2px solid #2e7d32;
  `;
  successMsg.textContent = message;
  
  document.body.appendChild(successMsg);
  
  // Animation
  successMsg.style.opacity = '0';
  successMsg.style.transform = 'translateX(-50%) translateY(-20px)';
  setTimeout(() => {
    successMsg.style.transition = 'all 0.3s ease';
    successMsg.style.opacity = '1';
    successMsg.style.transform = 'translateX(-50%) translateY(0)';
  }, 10);
  
  setTimeout(() => {
    successMsg.style.opacity = '0';
    successMsg.style.transform = 'translateX(-50%) translateY(-20px)';
    setTimeout(() => {
      if (successMsg.parentNode) {
        successMsg.parentNode.removeChild(successMsg);
      }
    }, 300);
  }, duration);
}


// ===== SICHERE INITIALISIERUNG =====
window.onload = function() {
  try {
    console.log('ğŸš€ Starte sichere Initialisierung...');
    
    canvas = document.getElementById('fireworkCanvas');
    if (!canvas) {
      console.error('âŒ Canvas-Element nicht gefunden!');
      alert('âŒ FEHLER: Canvas-Element nicht gefunden! Seite neu laden (F5)');
      return;
    }
    
    ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error('âŒ Canvas-Kontext nicht verfÃ¼gbar!');
      alert('âŒ FEHLER: Canvas wird nicht unterstÃ¼tzt!');
      return;
    }
    
    console.log('âœ… Canvas erfolgreich initialisiert');
    
    loadSavedShows();
    loadSavedEffects();
    loadEffectDatabase();
    loadIgnitionBoxPositions();
    drawCanvas();
    startAutoBackup();
    initializeAudioContext();
    setupEventListeners();
    
    console.log('âœ… Initialisierung erfolgreich abgeschlossen');
    
  } catch (error) {
    console.error('âŒ Kritischer Initialisierungsfehler:', error);
    alert('âŒ KRITISCHER FEHLER beim Laden der Anwendung!\n\nBitte Seite neu laden (F5)');
  }
};


function setupEventListeners() {
  if (!canvas) return;
  
  // Canvas click handler mit sicherer Implementierung
  const canvasClickHandler = function(e) {
    try {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Broadcast cursor position if collaborating
      if (isCollaborating) {
        broadcastCursorPosition(x, y);
      }
      
      // Check if clicked on ignition box
      let clickedBox = null;
      Object.keys(ignitionBoxPositions).forEach(boxName => {
        const pos = ignitionBoxPositions[boxName];
        if (x >= pos.x - 25 && x <= pos.x + 25 && y >= pos.y - 15 && y <= pos.y + 15) {
          clickedBox = boxName;
        }
      });
      
      if (clickedBox) {
        // Show ignition box details
        showIgnitionBoxDetails(clickedBox);
        return;
      }
      
      // Finde nicht platzierte Effekte
      const unplacedEffects = effects.filter(effect => effect.x === null || effect.y === null);
      
      if (unplacedEffects.length > 0) {
        const effectToPlace = unplacedEffects[0];
        effectToPlace.x = x;
        effectToPlace.y = y;
        
        // Update inventory
        updateInventoryForEffect(effectToPlace);
        
        updateEffectList();
        drawCanvas();
        
        // Sync with collaborators
        if (isCollaborating) {
          syncWithCollaborators();
        }
        
        // Zeige BestÃ¤tigung
        showSuccessMessage(`âœ… "${escapeHtml(effectToPlace.name)}" platziert!`);
      }
    } catch (error) {
      console.error('âŒ Fehler beim Canvas-Click:', error);
    }
  };
  
  addManagedEventListener(canvas, 'click', canvasClickHandler);
  
  // Mouse move for collaboration
  const mouseMoveHandler = function(e) {
    if (isCollaborating) {
      try {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        broadcastCursorPosition(x, y);
      } catch (error) {
        console.warn('âš ï¸ Fehler bei Cursor-Broadcast:', error);
      }
    }
  };
  
  addManagedEventListener(canvas, 'mousemove', mouseMoveHandler);
  
  // Mouse down for ignition box dragging
  const mouseDownHandler = function(e) {
    try {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Check if mouse is over an ignition box
      Object.keys(ignitionBoxPositions).forEach(boxName => {
        const pos = ignitionBoxPositions[boxName];
        if (x >= pos.x - 25 && x <= pos.x + 25 && y >= pos.y - 15 && y <= pos.y + 15) {
          draggedBox = boxName;
          isDraggingBox = true;
          dragOffset.x = x - pos.x;
          dragOffset.y = y - pos.y;
          canvas.style.cursor = 'grabbing';
          e.preventDefault();
        }
      });
    } catch (error) {
      console.error('âŒ Fehler bei Mouse-Down:', error);
    }
  };
  
  // Mouse move for box dragging
  const mouseMoveBoxHandler = function(e) {
    try {
      if (isDraggingBox && draggedBox) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Update box position
        ignitionBoxPositions[draggedBox].x = Math.max(25, Math.min(canvas.width - 25, x - dragOffset.x));
        ignitionBoxPositions[draggedBox].y = Math.max(15, Math.min(canvas.height - 15, y - dragOffset.y));
        
        drawCanvas();
        e.preventDefault();
      } else {
        // Check if hovering over a box for cursor change
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        let hoveringBox = false;
        Object.keys(ignitionBoxPositions).forEach(boxName => {
          const pos = ignitionBoxPositions[boxName];
          if (x >= pos.x - 25 && x <= pos.x + 25 && y >= pos.y - 15 && y <= pos.y + 15) {
            hoveringBox = true;
          }
        });
        
        canvas.style.cursor = hoveringBox ? 'grab' : 'crosshair';
      }
      
      // Original collaboration cursor broadcast
      if (isCollaborating) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        broadcastCursorPosition(x, y);
      }
    } catch (error) {
      console.warn('âš ï¸ Fehler bei Box-Bewegung:', error);
    }
  };
  
  // Mouse up for box dragging
  const mouseUpHandler = function(e) {
    try {
      if (isDraggingBox && draggedBox) {
        // Save new positions
        try {
          localStorage.setItem('ignitionBoxPositions', JSON.stringify(ignitionBoxPositions));
        } catch (saveError) {
          console.warn('âš ï¸ Konnte Box-Positionen nicht speichern:', saveError);
        }
        
        // Sync with collaborators
        if (isCollaborating) {
          syncWithCollaborators();
        }
        
        showSuccessMessage(`âœ… Box ${draggedBox} verschoben!`);
      }
      
      isDraggingBox = false;
      draggedBox = null;
      canvas.style.cursor = 'crosshair';
    } catch (error) {
      console.error('âŒ Fehler bei Mouse-Up:', error);
    }
  };
  
  addManagedEventListener(canvas, 'mousedown', mouseDownHandler);
  addManagedEventListener(canvas, 'mousemove', mouseMoveBoxHandler);
  addManagedEventListener(canvas, 'mouseup', mouseUpHandler);
  
  // Drag and drop for canvas
  const dragOverHandler = function(e) {
    e.preventDefault();
  };
  
  const dropHandler = function(e) {
    e.preventDefault();
    if (draggedEffect) {
      try {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        draggedEffect.x = x;
        draggedEffect.y = y;
        updateEffectList();
        drawCanvas();
        
        // Sync with collaborators
        if (isCollaborating) {
          syncWithCollaborators();
        }
        
        draggedEffect = null;
      } catch (error) {
        console.error('âŒ Fehler beim Drop:', error);
      }
    }
  };
  
  addManagedEventListener(canvas, 'dragover', dragOverHandler);
  addManagedEventListener(canvas, 'drop', dropHandler);
}


// ===== SICHERE ZEIT-FUNKTIONEN =====
function parseTime(timeStr) {
  if (!timeStr) return 0;
  try {
    const parts = timeStr.toString().split(':');
    if (parts.length === 2) {
      const minutes = safeParseInt(parts[0]);
      const seconds = safeParseInt(parts[1]);
      return minutes * 60 + seconds;
    }
    return safeParseInt(timeStr);
  } catch (error) {
    console.warn('âš ï¸ Fehler beim Parsen der Zeit:', timeStr, error);
    return 0;
  }
}


function formatTime(seconds) {
  try {
    const safeSeconds = safeParseInt(seconds);
    const mins = Math.floor(safeSeconds / 60);
    const secs = safeSeconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  } catch (error) {
    console.warn('âš ï¸ Fehler beim Formatieren der Zeit:', seconds, error);
    return '00:00';
  }
}


// ===== SICHERE EFFEKT-HINZUFÃœGUNG =====
function addEffect() {
  console.log('ğŸš€ SICHERE addEffect() Version 5.0 - ULTRA-SICHER');
  
  let backup = null;
  try {
    // SOFORTIGE ELEMENT-PRÃœFUNG
    const nameField = document.getElementById('name');
    const timeField = document.getElementById('time');
    
    if (!nameField || !timeField) {
      console.error('âŒ KRITISCH: Eingabefelder nicht gefunden!');
      alert('âŒ KRITISCHER FEHLER: Eingabefelder nicht gefunden!\n\nBitte lade die Seite neu (F5)!');
      return false;
    }
    
    // WERTE ERFASSEN mit Fallback
    const name = (nameField.value || '').trim();
    const time = (timeField.value || '').trim();
    
    console.log('ğŸ“ EINGABE-CHECK:', { name: `"${name}"`, time: `"${time}"` });
    
    // SOFORTIGE VALIDIERUNG
    if (!name) {
      console.log('âš ï¸ Kein Name eingegeben');
      alert('âŒ Bitte einen Effektnamen eingeben!');
      nameField.focus();
      nameField.style.borderColor = '#ff0000';
      nameField.style.boxShadow = '0 0 10px rgba(255,0,0,0.5)';
      setTimeout(() => {
        nameField.style.borderColor = '#555';
        nameField.style.boxShadow = 'none';
      }, 3000);
      return false;
    }
    
    if (!time) {
      console.log('âš ï¸ Keine Zeit eingegeben');
      alert('âŒ Bitte eine Showzeit eingeben (z.B. 1:30)!');
      timeField.focus();
      timeField.style.borderColor = '#ff0000';
      timeField.style.boxShadow = '0 0 10px rgba(255,0,0,0.5)';
      setTimeout(() => {
        timeField.style.borderColor = '#555';
        timeField.style.boxShadow = 'none';
      }, 3000);
      return false;
    }
    
    console.log('âœ… Validierung erfolgreich');
    
    // ALLE ANDEREN WERTE SICHER ERFASSEN
    const effectType = document.getElementById('effectType')?.value || 'rocket';
    const plannedDuration = document.getElementById('plannedDuration')?.value?.trim() || '';
    const price = safeParseFloat(document.getElementById('price')?.value);
    const barcode = document.getElementById('barcode')?.value?.trim() || '';
    const channel = document.getElementById('channel')?.value?.trim() || '';
    const receiver = document.getElementById('receiver')?.value?.trim() || '';
    const buttonKey = document.getElementById('buttonKey')?.value?.trim() || '';
    const quantity = Math.max(1, safeParseInt(document.getElementById('quantity')?.value, 1));
    const additionalInfo = document.getElementById('additionalInfo')?.value?.trim() || '';
    
    // SICHERE EINDEUTIGE ID
    const uniqueId = generateUniqueId();
    console.log('ğŸ”‘ ID generiert:', uniqueId);
    
    // NEUEN EFFEKT ERSTELLEN
    const newEffect = {
      id: uniqueId,
      name: name,
      effectType: effectType,
      plannedDuration: plannedDuration,
      price: price,
      barcode: barcode,
      time: parseTime(time),
      timeStr: time,
      channel: channel,
      receiver: receiver,
      buttonKey: buttonKey,
      quantity: quantity,
      additionalInfo: additionalInfo,
      image: currentEffectImage || null,
      video: currentEffectVideo || null,
      x: null,
      y: null,
      createdAt: new Date().toISOString()
    };
    
    console.log('ğŸ† Effekt erstellt:', newEffect);
    
    // BACKUP VOR Ã„NDERUNG
    backup = [...effects];
    console.log('ğŸ’¾ Backup erstellt mit', backup.length, 'Effekten');
    
    // HINZUFÃœGEN MIT SOFORTIGER PRÃœFUNG
    const oldLength = effects.length;
    effects.push(newEffect);
    const newLength = effects.length;
    
    console.log('ğŸ“Š Array-LÃ¤nge:', oldLength, 'â†’', newLength);
    
    if (newLength !== oldLength + 1) {
      throw new Error(`Array-LÃ¤nge stimmt nicht! Erwartet: ${oldLength + 1}, Erhalten: ${newLength}`);
    }
    
    const lastEffect = effects[effects.length - 1];
    if (!lastEffect || lastEffect.id !== uniqueId) {
      throw new Error('Letzter Effekt stimmt nicht Ã¼berein!');
    }
    
    console.log('âœ… Effekt erfolgreich hinzugefÃ¼gt!');
    
    // FORMULAR SICHER LEEREN
    try {
      nameField.value = '';
      timeField.value = '';
      
      const fieldsToReset = [
        'plannedDuration', 'price', 'barcode', 'channel', 
        'receiver', 'buttonKey', 'quantity', 'additionalInfo'
      ];
      
      fieldsToReset.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
      });
      
      clearImage();
      clearVideo();
      console.log('ğŸ§¹ Formular geleert');
    } catch (clearError) {
      console.warn('âš ï¸ Formular-Clearing-Fehler (nicht kritisch):', clearError);
    }
    
    // UI SICHER AKTUALISIEREN
    try {
      updateEffectList();
      updateCostCalculation();
      drawCanvas();
      checkInventoryWarnings();
      console.log('ğŸ”„ UI aktualisiert');
    } catch (uiError) {
      console.error('âŒ UI-Update-Fehler:', uiError);
      alert('âš ï¸ Effekt gespeichert, aber UI-Update fehlgeschlagen. Seite neu laden empfohlen.');
    }
    
    // KOLLABORATION
    if (isCollaborating) {
      try {
        syncWithCollaborators();
      } catch (syncError) {
        console.warn('âš ï¸ Kollaborations-Sync fehlgeschlagen:', syncError);
      }
    }
    
    // ERFOLGS-NACHRICHT
    console.log(`ğŸ‰ ERFOLG: "${name}" gespeichert! Show hat jetzt ${effects.length} Effekte`);
    
    // VISUELLE BESTÃ„TIGUNG
    showSuccessMessage(`âœ… "${escapeHtml(name)}" erfolgreich gespeichert! Show hat jetzt ${effects.length} Effekte`);
    
    // BUTTON-FEEDBACK
    const saveButton = document.querySelector('button[onclick="addEffect()"]');
    if (saveButton) {
      const originalText = saveButton.textContent;
      const originalBg = saveButton.style.background;
      
      saveButton.textContent = 'âœ… Gespeichert!';
      saveButton.style.background = '#4caf50';
      saveButton.style.transform = 'scale(1.05)';
      saveButton.style.transition = 'all 0.2s';
      
      setTimeout(() => {
        saveButton.textContent = originalText;
        saveButton.style.background = originalBg;
        saveButton.style.transform = 'scale(1)';
      }, 2000);
    }
    
    console.log('ğŸ‰ addEffect() KOMPLETT ERFOLGREICH!');
    return true;
    
  } catch (error) {
    console.error('âŒ KRITISCHER FEHLER in addEffect():', error);
    
    // Rollback bei Fehler
    try {
      if (Array.isArray(backup)) {
        effects.length = 0;
        effects.push(...backup);
        console.log('ğŸ”„ Backup wiederhergestellt');
      }
    } catch (rollbackError) {
      console.error('âŒ Rollback fehlgeschlagen:', rollbackError);
    }
    
    alert('âŒ Fehler beim Speichern des Effekts!\n\nFehler: ' + error.message + '\n\nBackup wurde wiederhergestellt.');
    return false;
  }
}


// ===== SICHERE EFFEKT-LISTE =====
function updateEffectList() {
  try {
    const list = document.getElementById('effectList');
    if (!list) {
      console.error('âŒ EffectList-Element nicht gefunden!');
      return;
    }
    
    list.innerHTML = '<h3>Effekte in der Show</h3>';
    
    if (!Array.isArray(effects)) {
      console.error('âŒ Effects ist kein Array!');
      effects = [];
      return;
    }
    
    effects.sort((a, b) => (a.time || 0) - (b.time || 0));
    
    effects.forEach(effect => {
      if (!effect || !effect.id) {
        console.warn('âš ï¸ UngÃ¼ltiger Effekt gefunden:', effect);
        return;
      }
      
      try {
        const div = document.createElement('div');
        div.className = 'effect-item';
        
        // Check inventory status
        const dbEffect = effectDatabase.find(e => 
          (e.name === effect.name) || (e.barcode && effect.barcode && e.barcode === effect.barcode)
        );
        
        if (dbEffect && typeof dbEffect.stockQuantity === 'number') {
          if (dbEffect.stockQuantity === 0) {
            div.classList.add('out-of-stock');
          } else if (dbEffect.stockQuantity < (effect.quantity || 1)) {
            div.classList.add('low-stock');
          }
        }
        
        div.draggable = true;
        
        // Sichere HTML-Erstellung
        const safeName = escapeHtml(effect.name || 'Unbenannt');
        const safeTimeStr = escapeHtml(effect.timeStr || '0:00');
        const safeEffectType = escapeHtml(effect.effectType || 'rocket');
        const safeChannel = escapeHtml(effect.channel || 'Nicht gesetzt');
        const safeButtonKey = escapeHtml(effect.buttonKey || 'Nicht gesetzt');
        const safePrice = (effect.price && effect.price > 0) ? safeParseFloat(effect.price).toFixed(2) : '0.00';
        const safeQuantity = Math.max(1, safeParseInt(effect.quantity, 1));
        
        const positionText = (effect.x !== null && effect.y !== null) 
          ? `X:${Math.round(effect.x)}, Y:${Math.round(effect.y)}` 
          : 'Nicht platziert';
        
        const stockText = (dbEffect && typeof dbEffect.stockQuantity === 'number') 
          ? `<br>Lager: ${dbEffect.stockQuantity}x` 
          : '';
        
        const ignitionText = (effect.ignitionBox && effect.ignitionChannel) 
          ? `<br><span style="color: #00ffff;">ğŸ“¡ Box ${escapeHtml(effect.ignitionBox)}-${escapeHtml(effect.ignitionChannel)}</span>` 
          : '';
        
        div.innerHTML = `
          <div style="display: flex; align-items: center;">
            ${effect.image ? `<img src="${effect.image}" class="effect-image" alt="Effekt" onerror="this.style.display='none';">` : ''}
            ${effect.video ? `<video src="${effect.video}" class="effect-video" muted onerror="this.style.display='none';"></video>` : ''}
            <div>
              <strong>${safeName}</strong><br>
              Zeit: ${safeTimeStr} | Typ: ${safeEffectType}<br>
              Kanal: ${safeChannel} | Taste: ${safeButtonKey}<br>
              Preis: ${safePrice}â‚¬ | Anzahl: ${safeQuantity}<br>
              Position: ${positionText}${stockText}${ignitionText}
            </div>
          </div>
          <div style="display: flex; gap: 5px;">
            <button onclick="selectEffectForIgnition('${effect.id}')" style="background: #ff9800; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;" title="Zu ZÃ¼ndanlage zuweisen">ğŸ“¡</button>
            <button class="effect-edit" onclick="editEffect('${effect.id}')" style="background: #2196f3; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">âœï¸</button>
            <button class="effect-delete" onclick="deleteEffect('${effect.id}')">Ã—</button>
          </div>
        `;
        
        // Add drag handlers
        div.addEventListener('dragstart', function(e) {
          draggedEffect = effect;
          div.classList.add('dragging');
        });
        
        div.addEventListener('dragend', function(e) {
          div.classList.remove('dragging');
        });
        
        list.appendChild(div);
        
      } catch (itemError) {
        console.error('âŒ Fehler beim Erstellen des Effekt-Items:', itemError, effect);
      }
    });
    
  } catch (error) {
    console.error('âŒ Fehler beim Aktualisieren der Effekt-Liste:', error);
  }
}


// ===== SICHERE KOSTEN-BERECHNUNG =====
function updateCostCalculation() {
  try {
    let totalCost = 0;
    let totalEffects = 0;
    
    if (Array.isArray(effects)) {
      effects.forEach(effect => {
        if (effect && typeof effect === 'object') {
          const price = safeParseFloat(effect.price);
          const quantity = Math.max(1, safeParseInt(effect.quantity, 1));
          totalCost += price * quantity;
          totalEffects += quantity;
        }
      });
    }
    
    const totalCostElement = document.getElementById('totalCost');
    const effectCountElement = document.getElementById('effectCount');
    
    if (totalCostElement) {
      totalCostElement.textContent = `Gesamtkosten: ${totalCost.toFixed(2)} â‚¬`;
    }
    
    if (effectCountElement) {
      effectCountElement.textContent = `Anzahl Effekte: ${totalEffects}`;
    }
    
    updateEffectOverview();
    
  } catch (error) {
    console.error('âŒ Fehler bei Kostenberechnung:', error);
  }
}

... (Rest des Skripts bleibt unverÃ¤ndert; aus PlatzgrÃ¼nden hier nicht nochmals vollstÃ¤ndig wiederholt)
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'987bf750f1359bf7',t:'MTc1OTMyMTc3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
