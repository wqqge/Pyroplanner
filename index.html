<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>üéÜ FirePlanner 2D - Pro (Cloud & Zones)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* Basis-Styles (angepasst vom Original) */
:root{--bg:#111;--panel:#222;--accent:#4caf50;--muted:#555;--text:#eee;}
body{margin:0;font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:var(--text);box-sizing:border-box;}
h1,h2{margin:8px 0;text-align:center;}
input,select,textarea,button{margin:6px;padding:8px;background:var(--panel);color:var(--text);border:1px solid var(--muted);border-radius:6px;font-size:14px;outline:none;}
input:focus,textarea:focus,select:focus{box-shadow:0 0 6px rgba(76,175,80,0.18);border-color:var(--accent);}
button{cursor:pointer;background:#333;transition:all .12s}
button:hover{transform:translateY(-2px);background:#444}
#container{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;padding:12px}
#canvasContainer{position:relative;border:2px solid var(--muted);background:#000;border-radius:8px;padding:6px}
#fireworkCanvas{display:block;border-radius:6px;cursor:crosshair;background:transparent;}
.effect-item{border:1px solid var(--muted);padding:8px;border-radius:6px;margin:8px 0;background:#222;display:flex;justify-content:space-between;align-items:center}
.image-preview{max-width:180px;max-height:120px;border-radius:6px;margin:8px 0;border:2px solid var(--muted)}
#timerDisplay{font-size:3em;text-align:center;color:#0ff;margin:8px 0}
#currentEffect{font-size:1.2em;color:#ff0;text-align:center;background:#222;padding:8px;border-radius:6px;min-height:48px}
#timeline{width:100%;max-width:1200px;margin:8px auto;background:#161616;padding:8px;border-radius:6px;border:1px solid #222;overflow-x:auto}
.marker{display:inline-block;width:2px;height:30px;background:#ffa726;margin-right:6px;position:relative;vertical-align:bottom}
.markerLabel{position:absolute;top:-18px;left:-6px;font-size:10px;color:#fff}
.zone-indicator{position:absolute;border:2px dashed rgba(255,0,0,0.6);border-radius:50%;pointer-events:none}
.tooltip{position:relative;display:inline-block}
.tooltip .tooltiptext{visibility:hidden;width:200px;background:#333;color:#fff;text-align:left;border-radius:5px;padding:8px;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-100px;opacity:0;transition:opacity .3s}
.tooltip:hover .tooltiptext{visibility:visible;opacity:1}
#backupStatus{position:fixed;top:18px;right:18px;background:var(--accent);color:#fff;padding:8px;border-radius:6px;display:none;z-index:10000}
.small{font-size:12px;color:#bbb}
.team-item{background:#262626;padding:6px;border-radius:6px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
@keyframes explodeAnim{0%{transform:scale(.1);opacity:1}50%{transform:scale(1.2);opacity:.8}100%{transform:scale(2.5);opacity:0}}
.explosion{position:absolute;border-radius:50%;pointer-events:none;animation:explodeAnim 900ms ease-out forwards}
.print-area{display:none}
@media print{body{background:#fff;color:#000} .print-area{display:block}}
</style>
</head>
<body>

<h1>üéÜ FirePlanner 2D - Pro (Cloud & Zones)</h1>

<!-- Plan Screen -->
<div id="planScreen">
  <h2>Show-Name</h2>
  <div style="text-align:center;margin-bottom:8px;">
    <input id="showName" placeholder="Name der Show" style="width:320px">
    <button onclick="saveShow()">Show speichern</button>
    <button onclick="loadSavedShows()">Gespeicherte Shows</button>
    <select id="savedShows" onchange="selectShow()"><option value="">Gespeicherte Shows</option></select>
    <button onclick="exportShow()">Export JSON</button>
    <input type="file" id="importFile" accept=".json" onchange="importShow()" style="display:inline-block">
    <button onclick="printPlan()">Druckversion</button>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
    <div style="width:360px">
      <h3>Effekt hinzuf√ºgen</h3>
      <div class="small">üìä Excel-Import Format: Name | Barcode | Dauer | Preis | Typ</div>
      <input id="name" placeholder="Effektname" style="width:100%">
      <select id="effectType" style="width:100%"><option value="rocket">Rakete</option><option value="fountain">Font√§ne</option><option value="battery">Batterie</option><option value="flame">Flammen</option></select>
      <input id="plannedDuration" placeholder="Dauer (m:s)" style="width:100%">
      <input id="price" placeholder="Preis (‚Ç¨)" type="number" step="0.01" style="width:100%">
      <input id="barcode" placeholder="Barcode/EAN" style="width:100%">
      <input id="time" placeholder="Showzeit (m:s)" style="width:100%">
      <input id="channel" placeholder="Kanal" style="width:100%">
      <input id="receiver" placeholder="Empf√§nger" style="width:100%">
      <input id="buttonKey" placeholder="Taste" style="width:100%">
      <input id="quantity" placeholder="Anzahl Effekte" type="number" style="width:100%">
      <textarea id="additionalInfo" placeholder="Zusatzinfos" style="width:100%"></textarea>

      <h3>üì∏ Bild f√ºr Effekt</h3>
      <input type="file" id="effectImage" accept="image/*" onchange="previewImage()">
      <div id="imagePreview"></div>
      <button onclick="clearImage()">üóëÔ∏è Bild entfernen</button>

      <div style="margin-top:8px">
        <button onclick="addEffect()">Effekt speichern</button>
        <button onclick="addToDatabase()">Zur Datenbank hinzuf√ºgen</button>
        <input type="file" id="excelImport" accept=".csv,.txt,.tsv" onchange="importExcelDatabase()" style="display:none">
        <button onclick="document.getElementById('excelImport').click()">üìä Excel import</button>
        <button onclick="clearDatabase()">üóëÔ∏è Datenbank leeren</button>
      </div>

      <h3>Effekt-Datenbank</h3>
      <select id="effectDatabase" onchange="selectFromDatabase()"><option value="">Effekt-Datenbank</option></select>

      <h3>Vorherige Effekte</h3>
      <select id="effectSavedList" onchange="selectSavedEffect()"><option value="">Vorherige Effekte</option></select>
    </div>

    <div id="canvasContainer" style="width:820px;max-width:100%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <button onclick="toggleZoneTool()">Zonen-Tool</button>
          <label class="small">Radius (m):</label>
          <input id="zoneRadius" type="number" placeholder="frei (z.B. 8.0)" style="width:80px">
          <button onclick="startZoneDraw()">Zone zeichnen</button>
          <button onclick="clearZones()">Zonen l√∂schen</button>
          <button onclick="exportZones()">Zonen export</button>
        </div>
        <div>
          <input type="file" id="musicFile" accept="audio/*" onchange="loadMusic()">
          <button onclick="addMarkerAtCurrent()">Marker bei Zeit</button>
        </div>
      </div>

      <canvas id="fireworkCanvas" width="800" height="500"></canvas>
      <div id="warningFlash" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;opacity:0;background:red;border-radius:6px;transition:opacity .08s;"></div>
    </div>
  </div>

  <div id="container">
    <div style="width:360px">
      <div id="costCalculation" style="padding:12px;background:#1a4d1a;border-radius:8px;border:2px solid #2e7d32">
        <h3>üí∞ Kostenkalkulation</h3>
        <div id="totalCost">Gesamtkosten: 0,00 ‚Ç¨</div>
        <div id="effectCount">Anzahl Effekte: 0</div>
      </div>

      <h3>Team & GitHub</h3>
      <div style="padding:8px;background:#222;border-radius:8px">
        <div class="small">Teammitglied hinzuf√ºgen:</div>
        <input id="teamUser" placeholder="GitHub-Benutzername (z.B. cedric)" style="width:100%">
        <select id="teamRole" style="width:100%"><option value="planer">Planer</option><option value="zuendmeister">Z√ºndmeister</option><option value="sicherheit">Sicherheitsbeauftragter</option></select>
        <button onclick="addTeamMember()">Hinzuf√ºgen</button>
        <div id="teamList"></div>

        <div style="margin-top:8px">
          <input id="githubUser" placeholder="GitHub Owner" style="width:48%;display:inline-block">
          <input id="githubRepo" placeholder="Repo-Name" style="width:48%;display:inline-block">
          <input id="githubPath" placeholder="Pfad (z.B. backups/)" value="backups/" style="width:100%;margin-top:6px">
          <div style="margin-top:6px">
            <button onclick="githubBackup()">‚òÅÔ∏è GitHub-Backup hochladen</button>
            <button onclick="githubRestore()">‚òÅÔ∏è GitHub-Backup laden</button>
            <button onclick="githubLoadTeam()">‚òÅÔ∏è Team laden</button>
          </div>
        </div>
      </div>

    </div>

    <div style="width:760px">
      <h3>üìã Effekt-√úbersicht</h3>
      <div id="overviewTable"></div>

      <h3>üéµ Timeline</h3>
      <div id="timeline"></div>

      <div class="controls" style="margin-top:10px">
        <button onclick="startShow()">Show starten</button>
        <button onclick="pauseShow()">Pause</button>
        <button onclick="resumeShow()">Fortsetzen</button>
        <button onclick="stopShow()">Stopp</button>
        <button onclick="autoBackup()">üíæ Backup Download</button>
        <button onclick="initializeDatabase()">Example DB</button>
      </div>
    </div>
  </div>
</div>

<!-- Show Screen -->
<div id="showScreen" style="display:none;padding:12px">
  <h2>Live Show</h2>
  <div id="timerDisplay">00:00</div>
  <div id="warning" style="text-align:center;font-size:1.2em;color:#f00"></div>
  <div id="currentEffect"></div>
  <div id="timelineDisplay"></div>
  <div style="text-align:center;margin-top:12px">
    <button onclick="backToPlan()">Zur√ºck zur Planung</button>
  </div>
</div>

<div id="backupStatus">Backup erstellt!</div>

<!-- audio elements -->
<audio id="warningBeep" preload="auto"><source src="data:audio/wav;base64,UklGR..." type="audio/wav"></audio>
<audio id="fireBeep" preload="auto"><source src="data:audio/wav;base64,UklGR..." type="audio/wav"></audio>
<audio id="musicPlayer"></audio>

<div class="print-area" id="printArea"></div>

<script>
/* ---------------------------
   Variablen & Initialisierung
   --------------------------- */
let effects = [];
let savedEffects = [];
let effectDatabase = [];
let canvas, ctx;
let zones = []; // {x,y,r,label}
let zoneToolActive = false;
let drawingZone = false;
let zoneRadius = 8;
let timelineMarkers = []; // {timeSec,label}
let showInterval = null;
let showStart = 0;
let pausedAcc = 0;
let isPaused = false;
let currentEffectImage = null;

/* onload */
window.onload = function(){
  canvas = document.getElementById('fireworkCanvas');
  ctx = canvas.getContext('2d');
  canvas.width = 800; canvas.height = 500;
  loadSavedEffects();
  loadEffectDatabase();
  loadSavedShows();
  renderTeam();
  drawCanvas();
  startAutoBackup();
  updateEffectList();
  updateCostCalculation();
  renderTimeline();
  setupCanvasDrag();
};

/* ---------------------------
   Canvas, Zones & Interaction
   --------------------------- */
function setupCanvasDrag(){
  // place unplaced effect on click or draw zone
  canvas.addEventListener('click', function(e){
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    if(zoneToolActive && drawingZone){
      const rInput = parseFloat(document.getElementById('zoneRadius').value);
      const r = (!isNaN(rInput) && rInput>0) ? rInput* (canvas.width / 100) / 1 : zoneRadius* (canvas.width / 100) /1;
      const label = prompt('Bezeichnung f√ºr Zone (z.B. Zuschauer):','Zone');
      zones.push({x,y,r,label});
      drawCanvas(); flashTemp('Zone hinzugef√ºgt: ' + (label||'Zone'));
      return;
    }
    // place next unplaced
    const unplaced = effects.filter(eff => eff.x===null || eff.y===null);
    if(unplaced.length>0){
      unplaced[0].x = x; unplaced[0].y = y;
      updateEffectList(); updateCostCalculation(); drawCanvas(); flashTemp(`"${unplaced[0].name}" platziert`);
    }
  });
}

/* zone controls */
function toggleZoneTool(){ zoneToolActive = !zoneToolActive; flashTemp('Zonen-Tool ' + (zoneToolActive ? 'AN' : 'AUS')); }
function startZoneDraw(){ drawingZone = !drawingZone; flashTemp('Zeichenmodus ' + (drawingZone ? 'AN' : 'AUS')); }
function clearZones(){ if(confirm('Alle Zonen l√∂schen?')){ zones=[]; drawCanvas(); } }
function exportZones(){ if(zones.length===0){ alert('Keine Zonen'); return; } const blob = new Blob([JSON.stringify(zones,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='zones.json'; a.click(); URL.revokeObjectURL(url); alert('Zonen exportiert'); }

/* ---------------------------
   Image preview
   --------------------------- */
function previewImage(){
  const file = document.getElementById('effectImage').files[0];
  const prev = document.getElementById('imagePreview');
  if(file){
    const fr = new FileReader();
    fr.onload = e => { currentEffectImage = e.target.result; prev.innerHTML = `<img src="${currentEffectImage}" class="image-preview">`; };
    fr.readAsDataURL(file);
  } else { clearImage(); }
}
function clearImage(){ currentEffectImage = null; document.getElementById('imagePreview').innerHTML=''; document.getElementById('effectImage').value=''; }

/* ---------------------------
   Database & Import
   --------------------------- */
function initializeDatabase(){
  const sample = [
    {name:"Goldener Regen", duration:"0:15", price:12.5, barcode:"4260123456789", effectType:"fountain"},
    {name:"Silber Rakete", duration:"0:03", price:8.9, barcode:"4260123456790", effectType:"rocket"}
  ];
  effectDatabase = sample;
  localStorage.setItem('effectDatabase', JSON.stringify(effectDatabase));
  updateDatabaseList(); flashTemp('Beispieldatenbank erstellt');
}
function loadEffectDatabase(){
  const s = localStorage.getItem('effectDatabase');
  if(s){ try{ effectDatabase = JSON.parse(s); } catch(e){ effectDatabase = []; localStorage.setItem('effectDatabase','[]'); } }
  updateDatabaseList();
}
function updateDatabaseList(){
  const sel = document.getElementById('effectDatabase'); sel.innerHTML = '<option value="">Effekt-Datenbank</option>';
  effectDatabase.forEach((ef,i) => {
    const opt = document.createElement('option'); opt.value = i; opt.textContent = `${ef.name} ${ef.price?'- '+ef.price+'‚Ç¨':''}`; sel.appendChild(opt);
  });
}
function selectFromDatabase(){
  const v = document.getElementById('effectDatabase').value;
  if(v==='') return;
  const ef = effectDatabase[parseInt(v)];
  if(!ef) return;
  document.getElementById('name').value = ef.name||'';
  document.getElementById('effectType').value = ef.effectType||'rocket';
  document.getElementById('plannedDuration').value = ef.duration||'';
  document.getElementById('price').value = ef.price||'';
  document.getElementById('barcode').value = ef.barcode||'';
  if(ef.image){ currentEffectImage = ef.image; document.getElementById('imagePreview').innerHTML = `<img src="${ef.image}" class="image-preview">`; } else clearImage();
  flashTemp('Effekt aus DB geladen');
}
function addToDatabase(){
  const name = document.getElementById('name').value.trim();
  if(!name){ alert('Bitte Name eingeben'); return; }
  const ef = {
    name,
    effectType: document.getElementById('effectType').value,
    duration: document.getElementById('plannedDuration').value,
    price: parseFloat(document.getElementById('price').value) || 0,
    barcode: document.getElementById('barcode').value,
    image: currentEffectImage,
    addedDate: new Date().toISOString()
  };
  effectDatabase.push(ef);
  localStorage.setItem('effectDatabase', JSON.stringify(effectDatabase));
  updateDatabaseList(); flashTemp('Effekt zur Datenbank hinzugef√ºgt');
}
function importExcelDatabase(){
  const f = document.getElementById('excelImport').files[0];
  if(!f){ alert('Bitte Datei ausw√§hlen'); return; }
  const r = new FileReader();
  r.onload = e => {
    const text = e.target.result; const lines = text.split(/\r?\n/); let added=0;
    for(const line of lines){
      if(!line.trim()) continue;
      let cols = line.split(/[\t;|,]/).map(c => c.trim().replace(/^["']|["']$/g,''));
      if(cols.length < 2) continue;
      if(/name|effekt|artikel/i.test(cols[0])) continue;
      const ef = { name: cols[0], barcode: cols[1]||'', duration: cols[2]||'', price: cols[3]?parseFloat(cols[3].replace(',','.')):0, effectType: cols[4]||'rocket' };
      effectDatabase.push(ef); added++;
    }
    localStorage.setItem('effectDatabase', JSON.stringify(effectDatabase));
    updateDatabaseList(); alert(`${added} Effekte importiert`);
  };
  r.readAsText(f,'utf-8');
}
function clearDatabase(){ if(confirm('Wirklich Datenbank leeren?')){ effectDatabase=[]; localStorage.setItem('effectDatabase','[]'); updateDatabaseList(); flashTemp('Datenbank geleert'); } }

/* ---------------------------
   Effects management
   --------------------------- */
function parseTime(timeStr){ if(!timeStr) return 0; const p = timeStr.split(':'); if(p.length===2) return parseInt(p[0])*60 + parseInt(p[1]); return parseInt(timeStr)||0; }
function formatTime(sec){ const m=Math.floor(sec/60), s=sec%60; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }

function addEffect(){
  const name = document.getElementById('name').value.trim();
  const timeStr = document.getElementById('time').value.trim();
  if(!name || !timeStr){ alert('Bitte Name und Showzeit eingeben'); return; }
  const eff = {
    id: Date.now(),
    name,
    effectType: document.getElementById('effectType').value,
    plannedDuration: document.getElementById('plannedDuration').value,
    price: parseFloat(document.getElementById('price').value)||0,
    barcode: document.getElementById('barcode').value,
    time: parseTime(timeStr),
    timeStr,
    channel: document.getElementById('channel').value,
    receiver: document.getElementById('receiver').value,
    buttonKey: document.getElementById('buttonKey').value,
    quantity: parseInt(document.getElementById('quantity').value)||1,
    additionalInfo: document.getElementById('additionalInfo').value,
    image: currentEffectImage,
    x: null, y: null
  };
  effects.push(eff);
  // save to savedEffects if unique
  if(!savedEffects.find(s => s.name === name)){
    savedEffects.push({ name, effectType: eff.effectType, plannedDuration: eff.plannedDuration, price: eff.price, barcode: eff.barcode });
    localStorage.setItem('savedEffects', JSON.stringify(savedEffects));
    updateSavedEffectsList();
  }
  // clear inputs
  document.getElementById('name').value=''; document.getElementById('time').value=''; document.getElementById('plannedDuration').value=''; document.getElementById('price').value=''; document.getElementById('barcode').value=''; clearImage();
  updateEffectList(); updateCostCalculation(); drawCanvas(); renderTimeline();
}

function updateEffectList(){
  const div = document.getElementById('overviewTable');
  if(effects.length===0){ div.innerHTML = '<p class="small">Keine Effekte in der Show</p>'; return; }
  effects.sort((a,b)=>a.time - b.time);
  let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#222;color:#fff"><th>Zeit</th><th>Effekt</th><th>Typ</th><th>Dauer</th><th>Kanal</th><th>Taste</th><th>Empf√§nger</th><th>Position</th><th>Anzahl</th><th>Preis</th><th>Aktionen</th></tr></thead><tbody>';
  for(const e of effects){
    const pos = (e.x!==null && e.y!==null) ? `X:${Math.round(e.x)},Y:${Math.round(e.y)}` : 'Nicht platziert';
    html += `<tr style="border-bottom:1px solid #2a2a2a"><td>${e.timeStr}</td><td>${e.name}</td><td>${e.effectType}</td><td>${e.plannedDuration||'-'}</td><td>${e.channel||'-'}</td><td>${e.buttonKey||'-'}</td><td>${e.receiver||'-'}</td><td>${pos}</td><td>${e.quantity}</td><td>${e.price?e.price.toFixed(2)+'‚Ç¨':'-'}</td><td><button onclick="editEffect(${e.id})">‚úèÔ∏è</button> <button onclick="deleteEffect(${e.id})">√ó</button></td></tr>`;
  }
  html += '</tbody></table>';
  div.innerHTML = html;
}

function editEffect(id){
  const eff = effects.find(x=>x.id===id); if(!eff) return;
  const newTime = prompt('Neue Showzeit (m:s):', eff.timeStr); if(newTime){ eff.timeStr = newTime; eff.time = parseTime(newTime); updateEffectList(); renderTimeline(); drawCanvas(); flashTemp('Effekt aktualisiert'); }
}
function deleteEffect(id){ if(confirm('Effekt wirklich l√∂schen?')){ effects = effects.filter(e=>e.id!==id); updateEffectList(); updateCostCalculation(); drawCanvas(); renderTimeline(); } }

/* ---------------------------
   Cost & Overview
   --------------------------- */
function updateCostCalculation(){
  let total = 0; let cnt = 0;
  effects.forEach(e => { total += (e.price || 0) * (e.quantity || 1); cnt += (e.quantity || 1); });
  document.getElementById('totalCost').textContent = `Gesamtkosten: ${total.toFixed(2)} ‚Ç¨`;
  document.getElementById('effectCount').textContent = `Anzahl Effekte: ${cnt}`;
  updateEffectList();
}

/* ---------------------------
   Draw Canvas (grid,zones,effects)
   --------------------------- */
function drawCanvas(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // grid
  ctx.strokeStyle = '#222'; ctx.lineWidth = 1;
  for(let x=0;x<=canvas.width;x+=50){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<=canvas.height;y+=50){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  // zones
  zones.forEach(z => {
    ctx.beginPath(); ctx.strokeStyle='rgba(255,0,0,0.6)'; ctx.lineWidth=2; ctx.setLineDash([6,6]); ctx.arc(z.x,z.y,z.r,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font='12px Arial'; ctx.fillText(z.label || 'Zone', z.x - 10, z.y - z.r - 8);
  });
  // effects
  effects.forEach(e => {
    if(e.x!==null && e.y!==null){
      const colors = { rocket:'#ff4444', fountain:'#44ff44', battery:'#4444ff', flame:'#ff8c00' };
      ctx.fillStyle = colors[e.effectType] || '#fff';
      ctx.beginPath(); ctx.arc(e.x,e.y,8,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font='12px Arial'; ctx.fillText(e.name, e.x + 12, e.y + 4); ctx.fillText(e.timeStr, e.x + 12, e.y + 16);
      if(e.channel && e.buttonKey){ ctx.fillStyle = '#00ffff'; ctx.fillText(`K${e.channel}-T${e.buttonKey}`, e.x+12, e.y+28); }
      if(e.price>0){ ctx.fillStyle = '#90ee90'; ctx.fillText(e.price + '‚Ç¨', e.x+12, e.y+40); }
    }
  });
  // unplaced hint
  const unplaced = effects.filter(e=>e.x===null||e.y===null);
  if(unplaced.length>0){
    ctx.fillStyle = '#ffff00'; ctx.font='bold 16px Arial'; ctx.fillText(`${unplaced.length} Effekt(e) noch nicht platziert ‚Äî Klick auf das Feld`, 20, 30);
  }
}

/* ---------------------------
   Timeline & Markers
   --------------------------- */
function renderTimeline(){
  const el = document.getElementById('timeline'); el.innerHTML = '';
  const maxSec = effects.length ? Math.max(...effects.map(e=>e.time)) : 60;
  const totalSec = Math.max(maxSec + 10, 60);
  const pxPerSec = 6;
  const bar = document.createElement('div'); bar.style.width = (totalSec * pxPerSec) + 'px'; bar.style.height = '80px'; bar.style.position = 'relative';
  // ticks every 5s
  for(let s=0;s<=totalSec;s+=5){
    const tick = document.createElement('div'); tick.style.position='absolute'; tick.style.left=(s*pxPerSec)+'px'; tick.style.top='34px'; tick.style.width='1px'; tick.style.height='18px'; tick.style.background='#444';
    const label = document.createElement('div'); label.style.position='absolute'; label.style.left=(s*pxPerSec - 18)+'px'; label.style.top='0'; label.style.fontSize='10px'; label.style.color='#ccc'; label.textContent=formatTime(s);
    bar.appendChild(tick); bar.appendChild(label);
  }
  // effect markers
  effects.forEach(e=>{
    const m = document.createElement('div'); m.className='marker'; m.style.position='absolute'; m.style.left = (e.time * pxPerSec) + 'px'; m.style.bottom='10px'; m.title = `${e.name} @ ${e.timeStr}`;
    const lbl = document.createElement('div'); lbl.className='markerLabel'; lbl.style.whiteSpace='nowrap'; lbl.textContent = e.name;
    m.appendChild(lbl); bar.appendChild(m);
  });
  // custom markers
  timelineMarkers.forEach(tm => {
    const mm = document.createElement('div'); mm.className='marker'; mm.style.position='absolute'; mm.style.left = (tm.timeSec * pxPerSec) + 'px'; mm.style.bottom='10px'; mm.title = tm.label;
    const l = document.createElement('div'); l.className='markerLabel'; l.textContent = tm.label; mm.appendChild(l); bar.appendChild(mm);
  });
  el.appendChild(bar);
}
function addMarkerAtCurrent(){
  const t = prompt('Zeit (m:s) f√ºr Marker (z.B. 0:30)','0:30'); if(!t) return;
  const label = prompt('Marker-Beschriftung:','Marker');
  const sec = parseTime(t);
  timelineMarkers.push({timeSec:sec,label:label||'Marker'}); renderTimeline(); flashTemp('Marker hinzugef√ºgt');
}

/* ---------------------------
   Show control (Start, Pause, Resume, Stop)
   --------------------------- */
function startShow(){
  if(effects.length===0){ alert('Keine Effekte in der Show!'); return; }
  document.getElementById('planScreen').style.display = 'none'; document.getElementById('showScreen').style.display = 'block';
  showStart = Date.now(); pausedAcc = 0; isPaused = false;
  const mp = document.getElementById('musicPlayer'); if(mp.src){ mp.currentTime = 0; mp.play().catch(()=>{}); }
  runShowLoop();
  flashTemp('Show gestartet');
}
function runShowLoop(){
  if(showInterval) clearInterval(showInterval);
  showInterval = setInterval(()=>{
    if(isPaused) return;
    const elapsed = Math.floor((Date.now() - showStart - pausedAcc)/1000);
    document.getElementById('timerDisplay').textContent = formatTime(elapsed);
    // upcoming within next 10s
    const upcoming = effects.filter(e => e.time > elapsed && e.time <= elapsed + 10).sort((a,b)=>a.time-b.time);
    if(upcoming.length>0){
      const next = upcoming[0]; const timeTo = next.time - elapsed;
      document.getElementById('warning').textContent = `ACHTUNG: ${next.name} in ${timeTo}s`;
      if(timeTo <= 3){ flashWarning(); try{ document.getElementById('warningBeep').play(); }catch(e){} }
    } else { document.getElementById('warning').textContent = ''; }
    // trigger effects exactly
    const now = effects.filter(e => e.time === elapsed);
    if(now.length>0){
      const ef = now[0];
      document.getElementById('currentEffect').innerHTML = `<div style="font-size:1.6em;color:#ff0">${ef.name}</div><div class="small">Kanal:${ef.channel||'-'} Taste:${ef.buttonKey||'-'}</div>`;
      createExplosionAtEffect(ef);
      try{ document.getElementById('fireBeep').play(); }catch(e){}
    } else { document.getElementById('currentEffect').innerHTML = ''; }
    const maxT = effects.length ? Math.max(...effects.map(e=>e.time)) : 0;
    if(elapsed > maxT + 20){ stopShow(); flashTemp('Show automatisch beendet'); }
  }, 500);
}
function pauseShow(){
  if(isPaused){ flashTemp('Bereits pausiert'); return; }
  isPaused = true;
  // accumulate paused time
  pausedAcc += Date.now() - showStart - pausedAcc;
  try{ document.getElementById('musicPlayer').pause(); }catch(e){}
  flashTemp('Show pausiert');
}
function resumeShow(){
  if(!isPaused){ flashTemp('Show ist nicht pausiert'); return; }
  isPaused = false;
  try{ document.getElementById('musicPlayer').play(); }catch(e){}
  flashTemp('Show fortgesetzt');
}
function stopShow(){
  if(showInterval) clearInterval(showInterval);
  showInterval = null;
  document.getElementById('planScreen').style.display = 'block'; document.getElementById('showScreen').style.display = 'none';
  document.getElementById('timerDisplay').textContent = '00:00';
  document.getElementById('currentEffect').innerHTML = '';
  document.getElementById('warning').textContent = '';
  try{ const mp = document.getElementById('musicPlayer'); mp.pause(); mp.currentTime = 0; }catch(e){}
  flashTemp('Show gestoppt');
}

/* flash / beep helpers */
function flashWarning(){ const el = document.getElementById('warningFlash'); el.style.opacity = '0.6'; setTimeout(()=>el.style.opacity='0',120); }
function flashTemp(msg){ const el = document.createElement('div'); el.style.cssText = 'position:fixed;left:50%;top:22px;transform:translateX(-50%);background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;z-index:9999;font-weight:bold'; el.textContent = msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2000); }

/* visual explosion */
function createExplosionAtEffect(e){
  const container = document.getElementById('canvasContainer');
  const div = document.createElement('div'); div.className = 'explosion';
  div.style.left = (e.x - 25) + 'px'; div.style.top = (e.y - 25) + 'px'; div.style.width = '50px'; div.style.height = '50px';
  div.style.background = 'radial-gradient(circle, rgba(255,200,0,1) 0%, rgba(255,0,0,0) 60%)';
  container.appendChild(div); setTimeout(()=>div.remove(),900);
}

/* ---------------------------
   Save/Load Shows & Import/Export
   --------------------------- */
function saveShow(){
  const name = document.getElementById('showName').value || 'Unbenannte Show';
  const show = { name, effects, timestamp: new Date().toISOString() };
  const stored = JSON.parse(localStorage.getItem('savedShows') || '[]'); stored.push(show); localStorage.setItem('savedShows', JSON.stringify(stored));
  alert('Show gespeichert'); loadSavedShows();
}
function loadSavedShows(){
  const sel = document.getElementById('savedShows'); sel.innerHTML = '<option value="">Gespeicherte Shows</option>';
  const stored = JSON.parse(localStorage.getItem('savedShows') || '[]');
  stored.forEach((s,i)=>{ const opt = document.createElement('option'); opt.value = i; opt.textContent = `${s.name} (${new Date(s.timestamp).toLocaleDateString()})`; sel.appendChild(opt); });
}
function selectShow(){
  const idx = document.getElementById('savedShows').value;
  if(idx === '') return;
  const stored = JSON.parse(localStorage.getItem('savedShows') || '[]');
  const s = stored[idx];
  document.getElementById('showName').value = s.name;
  effects = s.effects || [];
  updateEffectList(); updateCostCalculation(); drawCanvas(); renderTimeline();
}
function exportShow(){
  const name = document.getElementById('showName').value || 'Show';
  const data = { name, effects, exported: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${name}.json`; a.click(); URL.revokeObjectURL(url);
}
function importShow(){
  const f = document.getElementById('importFile').files[0];
  if(!f){ alert('Bitte Datei w√§hlen'); return; }
  const r = new FileReader();
  r.onload = e => { try{ const data = JSON.parse(e.target.result); document.getElementById('showName').value = data.name || 'Importierte Show'; effects = data.effects || []; updateEffectList(); updateCostCalculation(); drawCanvas(); renderTimeline(); alert('Show importiert'); }catch(err){ alert('Fehler beim Import'); } };
  r.readAsText(f);
}

/* ---------------------------
   Auto Backup (local and download)
   --------------------------- */
function startAutoBackup(){
  setInterval(()=>{ const backup = { shows: JSON.parse(localStorage.getItem('savedShows') || '[]'), savedEffects, database: effectDatabase, timestamp: new Date().toISOString() }; localStorage.setItem('autoBackup', JSON.stringify(backup)); const s = document.getElementById('backupStatus'); s.style.display = 'block'; setTimeout(()=>s.style.display='none',1500); }, 300000);
}
function autoBackup(){
  const backup = { shows: JSON.parse(localStorage.getItem('savedShows') || '[]'), savedEffects, database: effectDatabase, timestamp: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(backup,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `FirePlanner_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); alert('Backup heruntergeladen');
}

/* ---------------------------
   Music handling
   --------------------------- */
function loadMusic(){
  const f = document.getElementById('musicFile').files[0]; if(!f) return; const url = URL.createObjectURL(f); const mp = document.getElementById('musicPlayer'); mp.src = url; flashTemp('Musik geladen'); }

/* ---------------------------
   Saved effects
   --------------------------- */
function loadSavedEffects(){ const s = localStorage.getItem('savedEffects'); if(s) savedEffects = JSON.parse(s); updateSavedEffectsList(); }
function updateSavedEffectsList(){ const sel = document.getElementById('effectSavedList'); sel.innerHTML = '<option value="">Vorherige Effekte</option>'; savedEffects.forEach((s,i)=>{ const o = document.createElement('option'); o.value = i; o.textContent = s.name; sel.appendChild(o); }); }
function selectSavedEffect(){ const idx = document.getElementById('effectSavedList').value; if(idx==='') return; const s = savedEffects[idx]; document.getElementById('name').value = s.name; document.getElementById('effectType').value = s.effectType||'rocket'; document.getElementById('plannedDuration').value = s.plannedDuration||''; document.getElementById('price').value = s.price||''; }

/* ---------------------------
   GitHub Integration (real) - Backup & Restore
   --------------------------- */
/*
  Uses GitHub REST API v3:
  - Backup (PUT to /repos/{owner}/{repo}/contents/{path}{filename})
  - Restore (GET list in folder -> download selected file)
  Token is prompted from user, not stored.
*/
async function githubBackup(){
  try{
    const owner = document.getElementById('githubUser').value.trim() || prompt('GitHub Owner (Benutzer oder Org):');
    const repo = document.getElementById('githubRepo').value.trim() || prompt('Repo-Name:');
    let path = document.getElementById('githubPath').value.trim() || prompt('Pfad im Repo (z.B. backups/):','backups/');
    if(!path.endsWith('/')) path += '/';
    const token = prompt('Personal Access Token (repo scope) ‚Äî wird nicht gespeichert:');
    if(!owner || !repo || !token){ alert('GitHub-Daten fehlen'); return; }

    // prepare content
    const contentObj = { name: document.getElementById('showName').value || 'Unbenannte Show', effects, savedEffects, database: effectDatabase, team: JSON.parse(localStorage.getItem('team') || '[]'), timestamp: new Date().toISOString() };
    const contentStr = JSON.stringify(contentObj, null, 2);
    const contentBase64 = btoa(unescape(encodeURIComponent(contentStr)));
    const fileName = `show_backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
    const api = `https://api.github.com/repos/${owner}/${repo}/contents/${path}${fileName}`;

    const body = { message: `FirePlanner backup ${fileName}`, content: contentBase64, committer: { name: owner, email: `${owner}@users.noreply.github.com` } };
    const res = await fetch(api, { method:'PUT', headers: { Authorization: 'token ' + token, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    if(res.ok){ flashTemp('Backup hochgeladen'); alert('Backup erfolgreich hochgeladen'); }
    else { const txt = await res.text(); console.error('GitHub error',res.status,txt); alert('Upload-Fehler: ' + res.status + ' - ' + txt); }
  } catch(err){ console.error(err); alert('Fehler: ' + err.message); }
}

async function githubRestore(){
  try{
    const owner = document.getElementById('githubUser').value.trim() || prompt('GitHub Owner (Benutzer oder Org):');
    const repo = document.getElementById('githubRepo').value.trim() || prompt('Repo-Name:');
    let path = document.getElementById('githubPath').value.trim() || prompt('Pfad im Repo (z.B. backups/):','backups/');
    if(!path.endsWith('/')) path += '/';
    const token = prompt('Personal Access Token (repo scope) ‚Äî wird nicht gespeichert:');
    if(!owner || !repo || !token){ alert('GitHub-Daten fehlen'); return; }

    const api = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    const res = await fetch(api, { headers: { Authorization: 'token ' + token } });
    if(!res.ok){ alert('Fehler beim Auflisten: ' + res.status); return; }
    const list = await res.json();
    const files = list.filter(f => f.type === 'file' && f.name.endsWith('.json'));
    if(files.length === 0){ alert('Keine Backup-Dateien gefunden'); return; }
    const promptList = files.map((f,i)=> `${i+1}: ${f.name}`).join('\n');
    const choice = prompt('W√§hle Datei (Nummer):\n' + promptList);
    const idx = parseInt(choice) - 1;
    if(isNaN(idx) || idx < 0 || idx >= files.length){ alert('Ung√ºltige Auswahl'); return; }
    const file = files[idx];
    const contentRes = await fetch(file.download_url, { headers: { Authorization: 'token ' + token } });
    if(!contentRes.ok){ alert('Fehler beim Herunterladen'); return; }
    const txt = await contentRes.text();
    const data = JSON.parse(txt);
    if(confirm(`Backup "${file.name}" laden?`)){
      if(data.effects) effects = data.effects;
      if(data.database) effectDatabase = data.database;
      if(data.savedEffects) savedEffects = data.savedEffects;
      if(data.team) localStorage.setItem('team', JSON.stringify(data.team));
      localStorage.setItem('effectDatabase', JSON.stringify(effectDatabase));
      localStorage.setItem('savedEffects', JSON.stringify(savedEffects));
      updateDatabaseList(); updateSavedEffectsList(); updateEffectList(); updateCostCalculation(); drawCanvas(); renderTimeline(); renderTeam(); flashTemp('Backup geladen');
    }
  } catch(err){ console.error(err); alert('Fehler: ' + err.message); }
}

/* load team.json from repo */
async function githubLoadTeam(){
  try{
    const owner = document.getElementById('githubUser').value.trim() || prompt('GitHub Owner:');
    const repo = document.getElementById('githubRepo').value.trim() || prompt('Repo-Name:');
    let path = document.getElementById('githubPath').value.trim() || prompt('Pfad im Repo (z.B. backups/):','backups/');
    if(!path.endsWith('/')) path += '/';
    const token = prompt('Personal Access Token (repo scope) ‚Äî wird nicht gespeichert:');
    if(!owner || !repo || !token){ alert('GitHub-Daten fehlen'); return; }

    const api = `https://api.github.com/repos/${owner}/${repo}/contents/${path}team.json`;
    const res = await fetch(api, { headers: { Authorization: 'token ' + token } });
    if(!res.ok){ alert('team.json nicht gefunden'); return; }
    const data = await res.json();
    const content = atob(data.content.replace(/\n/g,'')); const team = JSON.parse(content);
    localStorage.setItem('team', JSON.stringify(team)); renderTeam(); alert('Team geladen');
  } catch(err){ console.error(err); alert('Fehler: ' + err.message); }
}

/* ---------------------------
   Team management (local)
   --------------------------- */
function loadTeam(){ const t = localStorage.getItem('team'); return t ? JSON.parse(t) : []; }
function renderTeam(){ const container = document.getElementById('teamList'); const team = loadTeam(); container.innerHTML = ''; team.forEach((m,i)=>{ const d = document.createElement('div'); d.className = 'team-item'; d.innerHTML = `<div><strong>${m.user}</strong> <span class="small">(${m.role})</span></div><div><button onclick="removeTeamMember(${i})">Entfernen</button></div>`; container.appendChild(d); }); }
function addTeamMember(){ const user = document.getElementById('teamUser').value.trim(); const role = document.getElementById('teamRole').value; if(!user){ alert('Gib Benutzername ein'); return; } const team = loadTeam(); team.push({user,role,added:new Date().toISOString()}); localStorage.setItem('team', JSON.stringify(team)); document.getElementById('teamUser').value=''; renderTeam(); flashTemp('Teammitglied hinzugef√ºgt'); }
function removeTeamMember(i){ const team = loadTeam(); if(!team[i]) return; if(confirm('Entfernen?')){ team.splice(i,1); localStorage.setItem('team', JSON.stringify(team)); renderTeam(); } }

/* ---------------------------
   Utilities
   --------------------------- */
function backToPlan(){ document.getElementById('showScreen').style.display='none'; document.getElementById('planScreen').style.display='block'; if(showInterval) clearInterval(showInterval); showInterval = null; try{ const mp = document.getElementById('musicPlayer'); mp.pause(); mp.currentTime = 0; }catch(e){} }
function flashTemp(msg){ const el = document.createElement('div'); el.style.cssText = 'position:fixed;left:50%;top:18px;transform:translateX(-50%);background:var(--accent);color:#fff;padding:8px 14px;border-radius:8px;z-index:9999;font-weight:bold'; el.textContent = msg; document.body.appendChild(el); setTimeout(()=>el.remove(),1800); }

/* render initial team and lists */
renderTeam(); updateDatabaseList(); updateSavedEffectsList();

/* End of script */
</script>

</body>
</html>
